"use strict";
/*
export async function bootstrap() {
}
*/
Object.defineProperty(exports, "__esModule", { value: true });
exports.destroyAsync = exports.destroy = exports.deployAsync = exports.deploy = exports.synth = exports.list = exports.bootstrap = void 0;
const colors = require("colors/safe");
const lib_1 = require("../lib");
const aws_auth_1 = require("./api/aws-auth");
const cloudformation_deployments_1 = require("./api/cloudformation-deployments");
const cloud_executable_1 = require("./api/cxapp/cloud-executable");
const exec_1 = require("./api/cxapp/exec");
const cdk_toolkit_1 = require("./cdk-toolkit");
const diff_1 = require("./diff");
const logging_1 = require("./logging");
const settings_1 = require("./settings");
/**
 * Bootstrap and returns the boostrapped environment. Only returns 1 environment.
 *
 * @param options CDK options
 *
 * @returns {
 *    environment: { account, region }
 *  }
 */
async function bootstrap(options = {}) {
    const { cli } = await initCommandLine(options);
    const environmentSpecs = [];
    const nonCli = true;
    const source = { source: 'default' };
    const bootstrapper = new lib_1.Bootstrapper(source);
    const bootstrapOptions = {
        toolkitStackName: undefined,
        roleArn: undefined,
        force: true,
    };
    const ret = await cli.bootstrap(environmentSpecs, bootstrapper, bootstrapOptions, nonCli, options.cdkOutputPath);
    return ret;
}
exports.bootstrap = bootstrap;
/**
 * List all stacks with dependencies.
 *
 * @param options CDK options
 *
 * @returns { stacks: [{ id, name, dependencies }] }
 */
async function list(options = {}) {
    const { cli } = await initCommandLine(options);
    const ret = await cli.list([], {
        nonCli: true,
        cdkOutputPath: options.cdkOutputPath,
    });
    return ret;
}
exports.list = list;
/**
 * Synth all stacks, and returns synthesized stacks.
 *
 * @param options CDK options
 *
 * @returns { stacks: [{ id, name }] }
 */
async function synth(options = {}) {
    const { cli } = await initCommandLine(options);
    const exclusively = false;
    const quiet = false;
    const ret = await cli.synth([], exclusively, quiet, {
        nonCli: true,
    });
    return ret;
}
exports.synth = synth;
/**
 * Deploy all stacks synchronously, used to deploy standard CDK app.
 *
 * @param options CDK options
 *
 * @returns { account, region, status: 'no_resources' | 'unchanged' | 'deployed'  }
 */
async function deploy(options = {}) {
    const { cli, toolkitStackName } = await initCommandLine(options);
    const ret = await cli.deploy({
        stackNames: options.stackName ? [options.stackName] : [],
        exclusively: true,
        requireApproval: diff_1.RequireApproval.Never,
        toolkitStackName,
        nonCli: true,
        asyncDeploy: false,
        skipChangeset: false,
    });
    return ret;
}
exports.deploy = deploy;
/**
 * Deploy all stacks in parallel asynchronously, and returns the environment deployed to and progress state.
 *
 * @param options CDK options
 *
 * @returns { account, region, status: 'no_resources' | 'unchanged' | 'deploying'  }
 */
async function deployAsync(options = {}) {
    process.env.CFN_QUICK_RETRY = 'true';
    const { cli, toolkitStackName } = await initCommandLine(options);
    const ret = await cli.deploy({
        stackNames: options.stackName ? [options.stackName] : [],
        exclusively: true,
        requireApproval: diff_1.RequireApproval.Never,
        toolkitStackName,
        force: options.force,
        nonCli: true,
        asyncDeploy: true,
        skipChangeset: true,
        cdkOutputPath: options.cdkOutputPath,
    });
    return ret;
}
exports.deployAsync = deployAsync;
/**
 * Destroy a single stack exclusively or destroy all stacks synchronously, used to destroy standard CDK app.
 *
 * @param options CDK options
 *
 * @returns { stacks: [{ id, name }] }
 */
async function destroy(options = {}) {
    process.env.CFN_QUICK_RETRY = 'true';
    const { cli } = await initCommandLine(options);
    const ret = await cli.destroy({
        stackNames: options.stackName ? [options.stackName] : [],
        exclusively: true,
        force: true,
        nonCli: true,
        asyncDestroy: false,
    });
    return ret;
}
exports.destroy = destroy;
/**
 * Destroy a single stack exclusively or destroy all stacks, and returns destroyed stacks.
 *
 * @param options CDK options
 *
 * @returns { stacks: [{ id, name }] }
 */
async function destroyAsync(options = {}) {
    process.env.CFN_QUICK_RETRY = 'true';
    const { cli } = await initCommandLine(options);
    const ret = await cli.destroy({
        stackNames: options.stackName ? [options.stackName] : [],
        exclusively: true,
        force: true,
        nonCli: true,
        asyncDestroy: true,
        cdkOutputPath: options.cdkOutputPath,
    });
    return ret;
}
exports.destroyAsync = destroyAsync;
async function initCommandLine(options = {}) {
    // set log level
    if (options.verbose) {
        logging_1.setLogLevel(options.verbose);
    }
    // set no color
    if (options.noColor) {
        colors.disable();
    }
    const argv = {
        app: options.app,
        output: options.output,
        _: ['list'],
    };
    const configuration = new settings_1.Configuration({
        commandLineArguments: {
            ...argv,
            _: argv._,
        },
    });
    await configuration.load();
    const sdkProvider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
        profile: configuration.settings.get(['profile']),
    });
    const cloudFormation = new cloudformation_deployments_1.CloudFormationDeployments({ sdkProvider });
    const cloudExecutable = new cloud_executable_1.CloudExecutable({
        configuration,
        sdkProvider,
        synthesizer: exec_1.execProgram,
    });
    const cli = new cdk_toolkit_1.CdkToolkit({
        cloudExecutable,
        cloudFormation,
        verbose: options.verbose ? options.verbose > 0 : false,
        configuration,
        sdkProvider,
    });
    const toolkitStackName = lib_1.ToolkitInfo.determineName(configuration.settings.get(['toolkitStackName']));
    return { cli, toolkitStackName };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVybGVzcy1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNlcnZlcmxlc3Mtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7RUFHRTs7O0FBRUYsc0NBQXNDO0FBQ3RDLGdDQUFvRTtBQUNwRSw2Q0FBNkM7QUFDN0MsaUZBQTZFO0FBQzdFLG1FQUErRDtBQUMvRCwyQ0FBK0M7QUFDL0MsK0NBQTJDO0FBQzNDLGlDQUF5QztBQUN6Qyx1Q0FBd0M7QUFDeEMseUNBQW9EO0FBY3BEOzs7Ozs7OztHQVFHO0FBQ0ksS0FBSyxVQUFVLFNBQVMsQ0FBQyxVQUFtQixFQUFHO0lBQ3BELE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxNQUFNLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMvQyxNQUFNLGdCQUFnQixHQUFZLEVBQUUsQ0FBQztJQUNyQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUM7SUFDcEIsTUFBTSxNQUFNLEdBQW9CLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDO0lBQ3RELE1BQU0sWUFBWSxHQUFHLElBQUksa0JBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5QyxNQUFNLGdCQUFnQixHQUFHO1FBQ3ZCLGdCQUFnQixFQUFFLFNBQVM7UUFDM0IsT0FBTyxFQUFFLFNBQVM7UUFDbEIsS0FBSyxFQUFFLElBQUk7S0FDWixDQUFDO0lBQ0YsTUFBTSxHQUFHLEdBQUcsTUFBTSxHQUFHLENBQUMsU0FBUyxDQUM3QixnQkFBZ0IsRUFDaEIsWUFBWSxFQUNaLGdCQUFnQixFQUNoQixNQUFNLEVBQ04sT0FBTyxDQUFDLGFBQWEsQ0FDdEIsQ0FBQztJQUNGLE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQW5CRCw4QkFtQkM7QUFFRDs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsSUFBSSxDQUFDLFVBQW1CLEVBQUc7SUFDL0MsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQy9DLE1BQU0sR0FBRyxHQUFHLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDN0IsTUFBTSxFQUFFLElBQUk7UUFDWixhQUFhLEVBQUUsT0FBTyxDQUFDLGFBQWE7S0FDckMsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDO0FBUEQsb0JBT0M7QUFFRDs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsS0FBSyxDQUFDLFVBQW1CLEVBQUc7SUFDaEQsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQy9DLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQztJQUMxQixNQUFNLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDcEIsTUFBTSxHQUFHLEdBQUcsTUFBTSxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFO1FBQ2xELE1BQU0sRUFBRSxJQUFJO0tBQ2IsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDO0FBUkQsc0JBUUM7QUFFRDs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsTUFBTSxDQUFDLFVBQW1CLEVBQUU7SUFDaEQsTUFBTSxFQUFFLEdBQUcsRUFBRSxnQkFBZ0IsRUFBRSxHQUFHLE1BQU0sZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2pFLE1BQU0sR0FBRyxHQUFHLE1BQU0sR0FBRyxDQUFDLE1BQU0sQ0FBQztRQUMzQixVQUFVLEVBQUUsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDeEQsV0FBVyxFQUFFLElBQUk7UUFDakIsZUFBZSxFQUFFLHNCQUFlLENBQUMsS0FBSztRQUN0QyxnQkFBZ0I7UUFDaEIsTUFBTSxFQUFFLElBQUk7UUFDWixXQUFXLEVBQUUsS0FBSztRQUNsQixhQUFhLEVBQUUsS0FBSztLQUNyQixDQUFDLENBQUM7SUFDSCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFaRCx3QkFZQztBQUVEOzs7Ozs7R0FNRztBQUNJLEtBQUssVUFBVSxXQUFXLENBQUMsVUFBbUIsRUFBRTtJQUNyRCxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsR0FBRyxNQUFNLENBQUM7SUFFckMsTUFBTSxFQUFFLEdBQUcsRUFBRSxnQkFBZ0IsRUFBRSxHQUFHLE1BQU0sZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2pFLE1BQU0sR0FBRyxHQUFHLE1BQU0sR0FBRyxDQUFDLE1BQU0sQ0FBQztRQUMzQixVQUFVLEVBQUUsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDeEQsV0FBVyxFQUFFLElBQUk7UUFDakIsZUFBZSxFQUFFLHNCQUFlLENBQUMsS0FBSztRQUN0QyxnQkFBZ0I7UUFDaEIsS0FBSyxFQUFFLE9BQU8sQ0FBQyxLQUFLO1FBQ3BCLE1BQU0sRUFBRSxJQUFJO1FBQ1osV0FBVyxFQUFFLElBQUk7UUFDakIsYUFBYSxFQUFFLElBQUk7UUFDbkIsYUFBYSxFQUFFLE9BQU8sQ0FBQyxhQUFhO0tBQ3JDLENBQUMsQ0FBQztJQUNILE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQWhCRCxrQ0FnQkM7QUFFRDs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsT0FBTyxDQUFDLFVBQW1CLEVBQUc7SUFDbEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEdBQUcsTUFBTSxDQUFDO0lBRXJDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxNQUFNLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMvQyxNQUFNLEdBQUcsR0FBRyxNQUFNLEdBQUcsQ0FBQyxPQUFPLENBQUM7UUFDNUIsVUFBVSxFQUFFLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ3hELFdBQVcsRUFBRSxJQUFJO1FBQ2pCLEtBQUssRUFBRSxJQUFJO1FBQ1gsTUFBTSxFQUFFLElBQUk7UUFDWixZQUFZLEVBQUUsS0FBSztLQUNwQixDQUFDLENBQUM7SUFDSCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFaRCwwQkFZQztBQUVEOzs7Ozs7R0FNRztBQUNJLEtBQUssVUFBVSxZQUFZLENBQUMsVUFBbUIsRUFBRztJQUN2RCxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsR0FBRyxNQUFNLENBQUM7SUFFckMsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQy9DLE1BQU0sR0FBRyxHQUFHLE1BQU0sR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUM1QixVQUFVLEVBQUUsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDeEQsV0FBVyxFQUFFLElBQUk7UUFDakIsS0FBSyxFQUFFLElBQUk7UUFDWCxNQUFNLEVBQUUsSUFBSTtRQUNaLFlBQVksRUFBRSxJQUFJO1FBQ2xCLGFBQWEsRUFBRSxPQUFPLENBQUMsYUFBYTtLQUNyQyxDQUFDLENBQUM7SUFDSCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFiRCxvQ0FhQztBQUVELEtBQUssVUFBVSxlQUFlLENBQUMsVUFBbUIsRUFBRztJQUNuRCxnQkFBZ0I7SUFDaEIsSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFO1FBQ25CLHFCQUFXLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQzlCO0lBRUQsZUFBZTtJQUNmLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRTtRQUNuQixNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7S0FDbEI7SUFFRCxNQUFNLElBQUksR0FBRztRQUNYLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRztRQUNoQixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU07UUFDdEIsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDO0tBQ1osQ0FBQztJQUNGLE1BQU0sYUFBYSxHQUFHLElBQUksd0JBQWEsQ0FBQztRQUN0QyxvQkFBb0IsRUFBRTtZQUNwQixHQUFHLElBQUk7WUFDUCxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQTJCO1NBQ3BDO0tBQ0YsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7SUFFM0IsTUFBTSxXQUFXLEdBQUcsTUFBTSxzQkFBVyxDQUFDLDRCQUE0QixDQUFDO1FBQ2pFLE9BQU8sRUFBRSxhQUFhLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBQ2pELENBQUMsQ0FBQztJQUVILE1BQU0sY0FBYyxHQUFHLElBQUksc0RBQXlCLENBQUMsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBRXRFLE1BQU0sZUFBZSxHQUFHLElBQUksa0NBQWUsQ0FBQztRQUMxQyxhQUFhO1FBQ2IsV0FBVztRQUNYLFdBQVcsRUFBRSxrQkFBVztLQUN6QixDQUFDLENBQUM7SUFFSCxNQUFNLEdBQUcsR0FBRyxJQUFJLHdCQUFVLENBQUM7UUFDekIsZUFBZTtRQUNmLGNBQWM7UUFDZCxPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUs7UUFDdEQsYUFBYTtRQUNiLFdBQVc7S0FDWixDQUFDLENBQUM7SUFFSCxNQUFNLGdCQUFnQixHQUFXLGlCQUFXLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFN0csT0FBTyxFQUFFLEdBQUcsRUFBRSxnQkFBZ0IsRUFBRSxDQUFDO0FBQ25DLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJvb3RzdHJhcCgpIHtcbn1cbiovXG5cbmltcG9ydCAqIGFzIGNvbG9ycyBmcm9tICdjb2xvcnMvc2FmZSc7XG5pbXBvcnQgeyBUb29sa2l0SW5mbywgQm9vdHN0cmFwU291cmNlLCBCb290c3RyYXBwZXIgfSBmcm9tICcuLi9saWInO1xuaW1wb3J0IHsgU2RrUHJvdmlkZXIgfSBmcm9tICcuL2FwaS9hd3MtYXV0aCc7XG5pbXBvcnQgeyBDbG91ZEZvcm1hdGlvbkRlcGxveW1lbnRzIH0gZnJvbSAnLi9hcGkvY2xvdWRmb3JtYXRpb24tZGVwbG95bWVudHMnO1xuaW1wb3J0IHsgQ2xvdWRFeGVjdXRhYmxlIH0gZnJvbSAnLi9hcGkvY3hhcHAvY2xvdWQtZXhlY3V0YWJsZSc7XG5pbXBvcnQgeyBleGVjUHJvZ3JhbSB9IGZyb20gJy4vYXBpL2N4YXBwL2V4ZWMnO1xuaW1wb3J0IHsgQ2RrVG9vbGtpdCB9IGZyb20gJy4vY2RrLXRvb2xraXQnO1xuaW1wb3J0IHsgUmVxdWlyZUFwcHJvdmFsIH0gZnJvbSAnLi9kaWZmJztcbmltcG9ydCB7IHNldExvZ0xldmVsIH0gZnJvbSAnLi9sb2dnaW5nJztcbmltcG9ydCB7IENvbW1hbmQsIENvbmZpZ3VyYXRpb24gfSBmcm9tICcuL3NldHRpbmdzJztcblxuaW50ZXJmYWNlIE9wdGlvbnMge1xuICAvLyBHZW5lcmljIGNvbmZpZ1xuICByZWFkb25seSBhcHA/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IG91dHB1dD86IHN0cmluZztcbiAgcmVhZG9ubHkgdmVyYm9zZT86IG51bWJlcjtcbiAgcmVhZG9ubHkgbm9Db2xvcj86IGJvb2xlYW47XG4gIC8vIENvbW1hbmQgc3BlY2lmaWMgY29uZmlnXG4gIHJlYWRvbmx5IGZvcmNlPzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgc3RhY2tOYW1lPzogc3RyaW5nO1xuICByZWFkb25seSBjZGtPdXRwdXRQYXRoPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIEJvb3RzdHJhcCBhbmQgcmV0dXJucyB0aGUgYm9vc3RyYXBwZWQgZW52aXJvbm1lbnQuIE9ubHkgcmV0dXJucyAxIGVudmlyb25tZW50LlxuICpcbiAqIEBwYXJhbSBvcHRpb25zIENESyBvcHRpb25zXG4gKlxuICogQHJldHVybnMge1xuICogICAgZW52aXJvbm1lbnQ6IHsgYWNjb3VudCwgcmVnaW9uIH1cbiAqICB9XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBib290c3RyYXAob3B0aW9uczogT3B0aW9ucyA9IHsgfSkge1xuICBjb25zdCB7IGNsaSB9ID0gYXdhaXQgaW5pdENvbW1hbmRMaW5lKG9wdGlvbnMpO1xuICBjb25zdCBlbnZpcm9ubWVudFNwZWNzOnN0cmluZ1tdID0gW107XG4gIGNvbnN0IG5vbkNsaSA9IHRydWU7XG4gIGNvbnN0IHNvdXJjZTogQm9vdHN0cmFwU291cmNlID0geyBzb3VyY2U6ICdkZWZhdWx0JyB9O1xuICBjb25zdCBib290c3RyYXBwZXIgPSBuZXcgQm9vdHN0cmFwcGVyKHNvdXJjZSk7XG4gIGNvbnN0IGJvb3RzdHJhcE9wdGlvbnMgPSB7XG4gICAgdG9vbGtpdFN0YWNrTmFtZTogdW5kZWZpbmVkLFxuICAgIHJvbGVBcm46IHVuZGVmaW5lZCxcbiAgICBmb3JjZTogdHJ1ZSxcbiAgfTtcbiAgY29uc3QgcmV0ID0gYXdhaXQgY2xpLmJvb3RzdHJhcChcbiAgICBlbnZpcm9ubWVudFNwZWNzLFxuICAgIGJvb3RzdHJhcHBlcixcbiAgICBib290c3RyYXBPcHRpb25zLFxuICAgIG5vbkNsaSxcbiAgICBvcHRpb25zLmNka091dHB1dFBhdGgsXG4gICk7XG4gIHJldHVybiByZXQ7XG59XG5cbi8qKlxuICogTGlzdCBhbGwgc3RhY2tzIHdpdGggZGVwZW5kZW5jaWVzLlxuICpcbiAqIEBwYXJhbSBvcHRpb25zIENESyBvcHRpb25zXG4gKlxuICogQHJldHVybnMgeyBzdGFja3M6IFt7IGlkLCBuYW1lLCBkZXBlbmRlbmNpZXMgfV0gfVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbGlzdChvcHRpb25zOiBPcHRpb25zID0geyB9KSB7XG4gIGNvbnN0IHsgY2xpIH0gPSBhd2FpdCBpbml0Q29tbWFuZExpbmUob3B0aW9ucyk7XG4gIGNvbnN0IHJldCA9IGF3YWl0IGNsaS5saXN0KFtdLCB7XG4gICAgbm9uQ2xpOiB0cnVlLFxuICAgIGNka091dHB1dFBhdGg6IG9wdGlvbnMuY2RrT3V0cHV0UGF0aCxcbiAgfSk7XG4gIHJldHVybiByZXQ7XG59XG5cbi8qKlxuICogU3ludGggYWxsIHN0YWNrcywgYW5kIHJldHVybnMgc3ludGhlc2l6ZWQgc3RhY2tzLlxuICpcbiAqIEBwYXJhbSBvcHRpb25zIENESyBvcHRpb25zXG4gKlxuICogQHJldHVybnMgeyBzdGFja3M6IFt7IGlkLCBuYW1lIH1dIH1cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHN5bnRoKG9wdGlvbnM6IE9wdGlvbnMgPSB7IH0pIHtcbiAgY29uc3QgeyBjbGkgfSA9IGF3YWl0IGluaXRDb21tYW5kTGluZShvcHRpb25zKTtcbiAgY29uc3QgZXhjbHVzaXZlbHkgPSBmYWxzZTtcbiAgY29uc3QgcXVpZXQgPSBmYWxzZTtcbiAgY29uc3QgcmV0ID0gYXdhaXQgY2xpLnN5bnRoKFtdLCBleGNsdXNpdmVseSwgcXVpZXQsIHtcbiAgICBub25DbGk6IHRydWUsXG4gIH0pO1xuICByZXR1cm4gcmV0O1xufVxuXG4vKipcbiAqIERlcGxveSBhbGwgc3RhY2tzIHN5bmNocm9ub3VzbHksIHVzZWQgdG8gZGVwbG95IHN0YW5kYXJkIENESyBhcHAuXG4gKlxuICogQHBhcmFtIG9wdGlvbnMgQ0RLIG9wdGlvbnNcbiAqXG4gKiBAcmV0dXJucyB7IGFjY291bnQsIHJlZ2lvbiwgc3RhdHVzOiAnbm9fcmVzb3VyY2VzJyB8ICd1bmNoYW5nZWQnIHwgJ2RlcGxveWVkJyAgfVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVwbG95KG9wdGlvbnM6IE9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7IGNsaSwgdG9vbGtpdFN0YWNrTmFtZSB9ID0gYXdhaXQgaW5pdENvbW1hbmRMaW5lKG9wdGlvbnMpO1xuICBjb25zdCByZXQgPSBhd2FpdCBjbGkuZGVwbG95KHtcbiAgICBzdGFja05hbWVzOiBvcHRpb25zLnN0YWNrTmFtZSA/IFtvcHRpb25zLnN0YWNrTmFtZV0gOiBbXSxcbiAgICBleGNsdXNpdmVseTogdHJ1ZSxcbiAgICByZXF1aXJlQXBwcm92YWw6IFJlcXVpcmVBcHByb3ZhbC5OZXZlcixcbiAgICB0b29sa2l0U3RhY2tOYW1lLFxuICAgIG5vbkNsaTogdHJ1ZSxcbiAgICBhc3luY0RlcGxveTogZmFsc2UsXG4gICAgc2tpcENoYW5nZXNldDogZmFsc2UsXG4gIH0pO1xuICByZXR1cm4gcmV0O1xufVxuXG4vKipcbiAqIERlcGxveSBhbGwgc3RhY2tzIGluIHBhcmFsbGVsIGFzeW5jaHJvbm91c2x5LCBhbmQgcmV0dXJucyB0aGUgZW52aXJvbm1lbnQgZGVwbG95ZWQgdG8gYW5kIHByb2dyZXNzIHN0YXRlLlxuICpcbiAqIEBwYXJhbSBvcHRpb25zIENESyBvcHRpb25zXG4gKlxuICogQHJldHVybnMgeyBhY2NvdW50LCByZWdpb24sIHN0YXR1czogJ25vX3Jlc291cmNlcycgfCAndW5jaGFuZ2VkJyB8ICdkZXBsb3lpbmcnICB9XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZXBsb3lBc3luYyhvcHRpb25zOiBPcHRpb25zID0ge30pIHtcbiAgcHJvY2Vzcy5lbnYuQ0ZOX1FVSUNLX1JFVFJZID0gJ3RydWUnO1xuXG4gIGNvbnN0IHsgY2xpLCB0b29sa2l0U3RhY2tOYW1lIH0gPSBhd2FpdCBpbml0Q29tbWFuZExpbmUob3B0aW9ucyk7XG4gIGNvbnN0IHJldCA9IGF3YWl0IGNsaS5kZXBsb3koe1xuICAgIHN0YWNrTmFtZXM6IG9wdGlvbnMuc3RhY2tOYW1lID8gW29wdGlvbnMuc3RhY2tOYW1lXSA6IFtdLFxuICAgIGV4Y2x1c2l2ZWx5OiB0cnVlLFxuICAgIHJlcXVpcmVBcHByb3ZhbDogUmVxdWlyZUFwcHJvdmFsLk5ldmVyLFxuICAgIHRvb2xraXRTdGFja05hbWUsXG4gICAgZm9yY2U6IG9wdGlvbnMuZm9yY2UsXG4gICAgbm9uQ2xpOiB0cnVlLFxuICAgIGFzeW5jRGVwbG95OiB0cnVlLFxuICAgIHNraXBDaGFuZ2VzZXQ6IHRydWUsXG4gICAgY2RrT3V0cHV0UGF0aDogb3B0aW9ucy5jZGtPdXRwdXRQYXRoLFxuICB9KTtcbiAgcmV0dXJuIHJldDtcbn1cblxuLyoqXG4gKiBEZXN0cm95IGEgc2luZ2xlIHN0YWNrIGV4Y2x1c2l2ZWx5IG9yIGRlc3Ryb3kgYWxsIHN0YWNrcyBzeW5jaHJvbm91c2x5LCB1c2VkIHRvIGRlc3Ryb3kgc3RhbmRhcmQgQ0RLIGFwcC5cbiAqXG4gKiBAcGFyYW0gb3B0aW9ucyBDREsgb3B0aW9uc1xuICpcbiAqIEByZXR1cm5zIHsgc3RhY2tzOiBbeyBpZCwgbmFtZSB9XSB9XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZXN0cm95KG9wdGlvbnM6IE9wdGlvbnMgPSB7IH0pIHtcbiAgcHJvY2Vzcy5lbnYuQ0ZOX1FVSUNLX1JFVFJZID0gJ3RydWUnO1xuXG4gIGNvbnN0IHsgY2xpIH0gPSBhd2FpdCBpbml0Q29tbWFuZExpbmUob3B0aW9ucyk7XG4gIGNvbnN0IHJldCA9IGF3YWl0IGNsaS5kZXN0cm95KHtcbiAgICBzdGFja05hbWVzOiBvcHRpb25zLnN0YWNrTmFtZSA/IFtvcHRpb25zLnN0YWNrTmFtZV0gOiBbXSxcbiAgICBleGNsdXNpdmVseTogdHJ1ZSxcbiAgICBmb3JjZTogdHJ1ZSxcbiAgICBub25DbGk6IHRydWUsXG4gICAgYXN5bmNEZXN0cm95OiBmYWxzZSxcbiAgfSk7XG4gIHJldHVybiByZXQ7XG59XG5cbi8qKlxuICogRGVzdHJveSBhIHNpbmdsZSBzdGFjayBleGNsdXNpdmVseSBvciBkZXN0cm95IGFsbCBzdGFja3MsIGFuZCByZXR1cm5zIGRlc3Ryb3llZCBzdGFja3MuXG4gKlxuICogQHBhcmFtIG9wdGlvbnMgQ0RLIG9wdGlvbnNcbiAqXG4gKiBAcmV0dXJucyB7IHN0YWNrczogW3sgaWQsIG5hbWUgfV0gfVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVzdHJveUFzeW5jKG9wdGlvbnM6IE9wdGlvbnMgPSB7IH0pIHtcbiAgcHJvY2Vzcy5lbnYuQ0ZOX1FVSUNLX1JFVFJZID0gJ3RydWUnO1xuXG4gIGNvbnN0IHsgY2xpIH0gPSBhd2FpdCBpbml0Q29tbWFuZExpbmUob3B0aW9ucyk7XG4gIGNvbnN0IHJldCA9IGF3YWl0IGNsaS5kZXN0cm95KHtcbiAgICBzdGFja05hbWVzOiBvcHRpb25zLnN0YWNrTmFtZSA/IFtvcHRpb25zLnN0YWNrTmFtZV0gOiBbXSxcbiAgICBleGNsdXNpdmVseTogdHJ1ZSxcbiAgICBmb3JjZTogdHJ1ZSxcbiAgICBub25DbGk6IHRydWUsXG4gICAgYXN5bmNEZXN0cm95OiB0cnVlLFxuICAgIGNka091dHB1dFBhdGg6IG9wdGlvbnMuY2RrT3V0cHV0UGF0aCxcbiAgfSk7XG4gIHJldHVybiByZXQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXRDb21tYW5kTGluZShvcHRpb25zOiBPcHRpb25zID0geyB9KSB7XG4gIC8vIHNldCBsb2cgbGV2ZWxcbiAgaWYgKG9wdGlvbnMudmVyYm9zZSkge1xuICAgIHNldExvZ0xldmVsKG9wdGlvbnMudmVyYm9zZSk7XG4gIH1cblxuICAvLyBzZXQgbm8gY29sb3JcbiAgaWYgKG9wdGlvbnMubm9Db2xvcikge1xuICAgIGNvbG9ycy5kaXNhYmxlKCk7XG4gIH1cblxuICBjb25zdCBhcmd2ID0ge1xuICAgIGFwcDogb3B0aW9ucy5hcHAsXG4gICAgb3V0cHV0OiBvcHRpb25zLm91dHB1dCxcbiAgICBfOiBbJ2xpc3QnXSxcbiAgfTtcbiAgY29uc3QgY29uZmlndXJhdGlvbiA9IG5ldyBDb25maWd1cmF0aW9uKHtcbiAgICBjb21tYW5kTGluZUFyZ3VtZW50czoge1xuICAgICAgLi4uYXJndixcbiAgICAgIF86IGFyZ3YuXyBhcyBbQ29tbWFuZCwgLi4uc3RyaW5nW11dLCAvLyBUeXBlU2NyaXB0IGF0IGl0cyBiZXN0XG4gICAgfSxcbiAgfSk7XG4gIGF3YWl0IGNvbmZpZ3VyYXRpb24ubG9hZCgpO1xuXG4gIGNvbnN0IHNka1Byb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7XG4gICAgcHJvZmlsZTogY29uZmlndXJhdGlvbi5zZXR0aW5ncy5nZXQoWydwcm9maWxlJ10pLFxuICB9KTtcblxuICBjb25zdCBjbG91ZEZvcm1hdGlvbiA9IG5ldyBDbG91ZEZvcm1hdGlvbkRlcGxveW1lbnRzKHsgc2RrUHJvdmlkZXIgfSk7XG5cbiAgY29uc3QgY2xvdWRFeGVjdXRhYmxlID0gbmV3IENsb3VkRXhlY3V0YWJsZSh7XG4gICAgY29uZmlndXJhdGlvbixcbiAgICBzZGtQcm92aWRlcixcbiAgICBzeW50aGVzaXplcjogZXhlY1Byb2dyYW0sXG4gIH0pO1xuXG4gIGNvbnN0IGNsaSA9IG5ldyBDZGtUb29sa2l0KHtcbiAgICBjbG91ZEV4ZWN1dGFibGUsXG4gICAgY2xvdWRGb3JtYXRpb24sXG4gICAgdmVyYm9zZTogb3B0aW9ucy52ZXJib3NlID8gb3B0aW9ucy52ZXJib3NlID4gMCA6IGZhbHNlLFxuICAgIGNvbmZpZ3VyYXRpb24sXG4gICAgc2RrUHJvdmlkZXIsXG4gIH0pO1xuXG4gIGNvbnN0IHRvb2xraXRTdGFja05hbWU6IHN0cmluZyA9IFRvb2xraXRJbmZvLmRldGVybWluZU5hbWUoY29uZmlndXJhdGlvbi5zZXR0aW5ncy5nZXQoWyd0b29sa2l0U3RhY2tOYW1lJ10pKTtcblxuICByZXR1cm4geyBjbGksIHRvb2xraXRTdGFja05hbWUgfTtcbn1cblxuIl19