"use strict";
/* eslint-disable @typescript-eslint/ban-ts-comment*/
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.attachPermissionsToRole = exports.PermissionType = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const iam = __importStar(require("@aws-cdk/aws-iam"));
const core_1 = require("@serverless-stack/core");
const Api_1 = require("../Api");
const Table_1 = require("../Table");
const Topic_1 = require("../Topic");
const Queue_1 = require("../Queue");
const Stack_1 = require("../Stack");
const construct_1 = require("./construct");
const logger = core_1.getChildLogger("resources");
var PermissionType;
(function (PermissionType) {
    PermissionType["ALL"] = "*";
})(PermissionType = exports.PermissionType || (exports.PermissionType = {}));
function attachPermissionsToRole(role, permissions) {
    // Four patterns
    //
    // attachPermissions(PermissionType.ALL);
    // attachPermissions([ 'sns', 'sqs' ]);
    // attachPermissions([ event, queue ]);
    // attachPermissions([
    //   [ event.snsTopic, 'grantPublish' ],
    //   [ queue.sqsQueue, 'grantSendMessages' ],
    // ]);
    // attachPermissions([
    //   new iam.PolicyStatement({
    //     actions: ["s3:*"],
    //     effect: iam.Effect.ALLOW,
    //     resources: [
    //       bucket.bucketArn + "/private/${cognito-identity.amazonaws.com:sub}/*",
    //     ],
    //   })
    // ]);
    ////////////////////////////////////
    // Case: 'admin' permissions => '*'
    ////////////////////////////////////
    if (typeof permissions === "string") {
        if (permissions === PermissionType.ALL) {
            role.addToPolicy(buildPolicy(permissions, ["*"]));
        }
        else {
            throw new Error(`The specified permissions are not supported.`);
        }
        return;
    }
    if (!Array.isArray(permissions)) {
        throw new Error(`The specified permissions are not supported. They are expected to be PermissionType.ALL or an array.`);
    }
    // Handle array of permissions
    permissions.forEach((permission) => {
        // Case: 's3' permissions => 's3:*'
        if (typeof permission === "string") {
            role.addToPolicy(buildPolicy(`${permission}:*`, ["*"]));
            return;
        }
        ////////////////////////////////////
        // Case: iam.PolicyStatement
        ////////////////////////////////////
        if (construct_1.isConstructOf(permission, "aws-iam.PolicyStatement")) {
            role.addToPolicy(permission);
        }
        ////////////////////////////////////
        // Case: CDK constructs
        ////////////////////////////////////
        else if (construct_1.isConstructOf(permission, "aws-dynamodb.Table")) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            const tableArn = permission.tableArn;
            role.addToPolicy(buildPolicy("dynamodb:*", [tableArn, `${tableArn}/*`]));
        }
        else if (construct_1.isConstructOf(permission, "aws-sns.Topic")) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("sns:*", [permission.topicArn]));
        }
        else if (construct_1.isConstructOf(permission, "aws-sqs.Queue")) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("sqs:*", [permission.queueArn]));
        }
        else if (construct_1.isConstructOf(permission, "aws-s3.Bucket")) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            const bucketArn = permission.bucketArn;
            role.addToPolicy(buildPolicy("s3:*", [bucketArn, `${bucketArn}/*`]));
        }
        ////////////////////////////////////
        // Case: SST construct => 's3:*'
        ////////////////////////////////////
        else if (permission instanceof Api_1.Api) {
            const httpApi = permission.httpApi;
            const { account, region } = Stack_1.Stack.of(httpApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${httpApi.httpApiId}/*`,
            ]));
        }
        else if (permission instanceof Table_1.Table) {
            const tableArn = permission.dynamodbTable.tableArn;
            role.addToPolicy(buildPolicy("dynamodb:*", [tableArn, `${tableArn}/*`]));
        }
        else if (permission instanceof Topic_1.Topic) {
            role.addToPolicy(buildPolicy("sns:*", [permission.snsTopic.topicArn]));
        }
        else if (permission instanceof Queue_1.Queue) {
            role.addToPolicy(buildPolicy("sqs:*", [permission.sqsQueue.queueArn]));
        }
        ////////////////////////////////////
        // Case: grant method
        ////////////////////////////////////
        else if (Array.isArray(permission) &&
            permission.length === 2 &&
            cdk.Construct.isConstruct(permission[0]) &&
            typeof permission[1] === "string") {
            const construct = permission[0];
            const methodName = permission[1];
            construct[methodName](role);
        }
        else {
            logger.debug("permission object", permission);
            throw new Error(`The specified permissions are not supported.`);
        }
    });
}
exports.attachPermissionsToRole = attachPermissionsToRole;
function buildPolicy(action, resources) {
    return new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        actions: [action],
        resources,
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3Blcm1pc3Npb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHFEQUFxRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVyRCxtREFBcUM7QUFDckMsc0RBQXdDO0FBQ3hDLGlEQUF3RDtBQUN4RCxnQ0FBNkI7QUFDN0Isb0NBQWlDO0FBQ2pDLG9DQUFpQztBQUNqQyxvQ0FBaUM7QUFDakMsb0NBQWlDO0FBQ2pDLDJDQUE0QztBQUU1QyxNQUFNLE1BQU0sR0FBRyxxQkFBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBUzNDLElBQVksY0FFWDtBQUZELFdBQVksY0FBYztJQUN4QiwyQkFBUyxDQUFBO0FBQ1gsQ0FBQyxFQUZXLGNBQWMsR0FBZCxzQkFBYyxLQUFkLHNCQUFjLFFBRXpCO0FBRUQsU0FBZ0IsdUJBQXVCLENBQ3JDLElBQWMsRUFDZCxXQUF3QjtJQUV4QixnQkFBZ0I7SUFDaEIsRUFBRTtJQUNGLHlDQUF5QztJQUN6Qyx1Q0FBdUM7SUFDdkMsdUNBQXVDO0lBQ3ZDLHNCQUFzQjtJQUN0Qix3Q0FBd0M7SUFDeEMsNkNBQTZDO0lBQzdDLE1BQU07SUFDTixzQkFBc0I7SUFDdEIsOEJBQThCO0lBQzlCLHlCQUF5QjtJQUN6QixnQ0FBZ0M7SUFDaEMsbUJBQW1CO0lBQ25CLCtFQUErRTtJQUMvRSxTQUFTO0lBQ1QsT0FBTztJQUNQLE1BQU07SUFFTixvQ0FBb0M7SUFDcEMsbUNBQW1DO0lBQ25DLG9DQUFvQztJQUNwQyxJQUFJLE9BQU8sV0FBVyxLQUFLLFFBQVEsRUFBRTtRQUNuQyxJQUFJLFdBQVcsS0FBSyxjQUFjLENBQUMsR0FBRyxFQUFFO1lBQ3RDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNuRDthQUFNO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyw4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ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudCovXG5cbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJAYXdzLWNkay9hd3MtaWFtXCI7XG5pbXBvcnQgeyBnZXRDaGlsZExvZ2dlciB9IGZyb20gXCJAc2VydmVybGVzcy1zdGFjay9jb3JlXCI7XG5pbXBvcnQgeyBBcGkgfSBmcm9tIFwiLi4vQXBpXCI7XG5pbXBvcnQgeyBUYWJsZSB9IGZyb20gXCIuLi9UYWJsZVwiO1xuaW1wb3J0IHsgVG9waWMgfSBmcm9tIFwiLi4vVG9waWNcIjtcbmltcG9ydCB7IFF1ZXVlIH0gZnJvbSBcIi4uL1F1ZXVlXCI7XG5pbXBvcnQgeyBTdGFjayB9IGZyb20gXCIuLi9TdGFja1wiO1xuaW1wb3J0IHsgaXNDb25zdHJ1Y3RPZiB9IGZyb20gXCIuL2NvbnN0cnVjdFwiO1xuXG5jb25zdCBsb2dnZXIgPSBnZXRDaGlsZExvZ2dlcihcInJlc291cmNlc1wiKTtcblxuZXhwb3J0IHR5cGUgUGVybWlzc2lvbnMgPSBQZXJtaXNzaW9uVHlwZSB8IFBlcm1pc3Npb25bXTtcbnR5cGUgUGVybWlzc2lvbiA9XG4gIHwgc3RyaW5nXG4gIHwgY2RrLkNvbnN0cnVjdFxuICB8IFtjZGsuQ29uc3RydWN0LCBzdHJpbmddXG4gIHwgaWFtLlBvbGljeVN0YXRlbWVudDtcblxuZXhwb3J0IGVudW0gUGVybWlzc2lvblR5cGUge1xuICBBTEwgPSBcIipcIixcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGF0dGFjaFBlcm1pc3Npb25zVG9Sb2xlKFxuICByb2xlOiBpYW0uUm9sZSxcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25zXG4pOiB2b2lkIHtcbiAgLy8gRm91ciBwYXR0ZXJuc1xuICAvL1xuICAvLyBhdHRhY2hQZXJtaXNzaW9ucyhQZXJtaXNzaW9uVHlwZS5BTEwpO1xuICAvLyBhdHRhY2hQZXJtaXNzaW9ucyhbICdzbnMnLCAnc3FzJyBdKTtcbiAgLy8gYXR0YWNoUGVybWlzc2lvbnMoWyBldmVudCwgcXVldWUgXSk7XG4gIC8vIGF0dGFjaFBlcm1pc3Npb25zKFtcbiAgLy8gICBbIGV2ZW50LnNuc1RvcGljLCAnZ3JhbnRQdWJsaXNoJyBdLFxuICAvLyAgIFsgcXVldWUuc3FzUXVldWUsICdncmFudFNlbmRNZXNzYWdlcycgXSxcbiAgLy8gXSk7XG4gIC8vIGF0dGFjaFBlcm1pc3Npb25zKFtcbiAgLy8gICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gIC8vICAgICBhY3Rpb25zOiBbXCJzMzoqXCJdLFxuICAvLyAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAvLyAgICAgcmVzb3VyY2VzOiBbXG4gIC8vICAgICAgIGJ1Y2tldC5idWNrZXRBcm4gKyBcIi9wcml2YXRlLyR7Y29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOnN1Yn0vKlwiLFxuICAvLyAgICAgXSxcbiAgLy8gICB9KVxuICAvLyBdKTtcblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gQ2FzZTogJ2FkbWluJyBwZXJtaXNzaW9ucyA9PiAnKidcbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIGlmICh0eXBlb2YgcGVybWlzc2lvbnMgPT09IFwic3RyaW5nXCIpIHtcbiAgICBpZiAocGVybWlzc2lvbnMgPT09IFBlcm1pc3Npb25UeXBlLkFMTCkge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShwZXJtaXNzaW9ucywgW1wiKlwiXSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBzcGVjaWZpZWQgcGVybWlzc2lvbnMgYXJlIG5vdCBzdXBwb3J0ZWQuYCk7XG4gICAgfVxuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICghQXJyYXkuaXNBcnJheShwZXJtaXNzaW9ucykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlIHNwZWNpZmllZCBwZXJtaXNzaW9ucyBhcmUgbm90IHN1cHBvcnRlZC4gVGhleSBhcmUgZXhwZWN0ZWQgdG8gYmUgUGVybWlzc2lvblR5cGUuQUxMIG9yIGFuIGFycmF5LmBcbiAgICApO1xuICB9XG5cbiAgLy8gSGFuZGxlIGFycmF5IG9mIHBlcm1pc3Npb25zXG4gIHBlcm1pc3Npb25zLmZvckVhY2goKHBlcm1pc3Npb246IFBlcm1pc3Npb24pID0+IHtcbiAgICAvLyBDYXNlOiAnczMnIHBlcm1pc3Npb25zID0+ICdzMzoqJ1xuICAgIGlmICh0eXBlb2YgcGVybWlzc2lvbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShgJHtwZXJtaXNzaW9ufToqYCwgW1wiKlwiXSkpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENhc2U6IGlhbS5Qb2xpY3lTdGF0ZW1lbnRcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBpZiAoaXNDb25zdHJ1Y3RPZihwZXJtaXNzaW9uIGFzIGNkay5Db25zdHJ1Y3QsIFwiYXdzLWlhbS5Qb2xpY3lTdGF0ZW1lbnRcIikpIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3kocGVybWlzc2lvbiBhcyBpYW0uUG9saWN5U3RhdGVtZW50KTtcbiAgICB9XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ2FzZTogQ0RLIGNvbnN0cnVjdHNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBlbHNlIGlmIChpc0NvbnN0cnVjdE9mKHBlcm1pc3Npb24gYXMgY2RrLkNvbnN0cnVjdCwgXCJhd3MtZHluYW1vZGIuVGFibGVcIikpIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgY29uc3QgdGFibGVBcm4gPSBwZXJtaXNzaW9uLnRhYmxlQXJuO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcImR5bmFtb2RiOipcIiwgW3RhYmxlQXJuLCBgJHt0YWJsZUFybn0vKmBdKSk7XG4gICAgfSBlbHNlIGlmIChpc0NvbnN0cnVjdE9mKHBlcm1pc3Npb24gYXMgY2RrLkNvbnN0cnVjdCwgXCJhd3Mtc25zLlRvcGljXCIpKSB7XG4gICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIFdlIGRvIG5vdCB3YW50IHRvIGltcG9ydCB0aGUgY2RrIG1vZHVsZXMsIGp1c3QgY2FzdCB0byBhbnlcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJzbnM6KlwiLCBbcGVybWlzc2lvbi50b3BpY0Fybl0pKTtcbiAgICB9IGVsc2UgaWYgKGlzQ29uc3RydWN0T2YocGVybWlzc2lvbiBhcyBjZGsuQ29uc3RydWN0LCBcImF3cy1zcXMuUXVldWVcIikpIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInNxczoqXCIsIFtwZXJtaXNzaW9uLnF1ZXVlQXJuXSkpO1xuICAgIH0gZWxzZSBpZiAoaXNDb25zdHJ1Y3RPZihwZXJtaXNzaW9uIGFzIGNkay5Db25zdHJ1Y3QsIFwiYXdzLXMzLkJ1Y2tldFwiKSkge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBXZSBkbyBub3Qgd2FudCB0byBpbXBvcnQgdGhlIGNkayBtb2R1bGVzLCBqdXN0IGNhc3QgdG8gYW55XG4gICAgICBjb25zdCBidWNrZXRBcm4gPSBwZXJtaXNzaW9uLmJ1Y2tldEFybjtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJzMzoqXCIsIFtidWNrZXRBcm4sIGAke2J1Y2tldEFybn0vKmBdKSk7XG4gICAgfVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENhc2U6IFNTVCBjb25zdHJ1Y3QgPT4gJ3MzOionXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIEFwaSkge1xuICAgICAgY29uc3QgaHR0cEFwaSA9IHBlcm1pc3Npb24uaHR0cEFwaTtcbiAgICAgIGNvbnN0IHsgYWNjb3VudCwgcmVnaW9uIH0gPSBTdGFjay5vZihodHRwQXBpKTtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwiZXhlY3V0ZS1hcGk6SW52b2tlXCIsIFtcbiAgICAgICAgICBgYXJuOmF3czpleGVjdXRlLWFwaToke3JlZ2lvbn06JHthY2NvdW50fToke2h0dHBBcGkuaHR0cEFwaUlkfS8qYCxcbiAgICAgICAgXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgVGFibGUpIHtcbiAgICAgIGNvbnN0IHRhYmxlQXJuID0gcGVybWlzc2lvbi5keW5hbW9kYlRhYmxlLnRhYmxlQXJuO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcImR5bmFtb2RiOipcIiwgW3RhYmxlQXJuLCBgJHt0YWJsZUFybn0vKmBdKSk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgVG9waWMpIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJzbnM6KlwiLCBbcGVybWlzc2lvbi5zbnNUb3BpYy50b3BpY0Fybl0pKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBRdWV1ZSkge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInNxczoqXCIsIFtwZXJtaXNzaW9uLnNxc1F1ZXVlLnF1ZXVlQXJuXSkpO1xuICAgIH1cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDYXNlOiBncmFudCBtZXRob2RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBlbHNlIGlmIChcbiAgICAgIEFycmF5LmlzQXJyYXkocGVybWlzc2lvbikgJiZcbiAgICAgIHBlcm1pc3Npb24ubGVuZ3RoID09PSAyICYmXG4gICAgICBjZGsuQ29uc3RydWN0LmlzQ29uc3RydWN0KHBlcm1pc3Npb25bMF0pICYmXG4gICAgICB0eXBlb2YgcGVybWlzc2lvblsxXSA9PT0gXCJzdHJpbmdcIlxuICAgICkge1xuICAgICAgY29uc3QgY29uc3RydWN0ID0gcGVybWlzc2lvblswXSBhcyBjZGsuQ29uc3RydWN0O1xuICAgICAgY29uc3QgbWV0aG9kTmFtZSA9IHBlcm1pc3Npb25bMV0gYXMga2V5b2YgY2RrLkNvbnN0cnVjdDtcbiAgICAgIChjb25zdHJ1Y3RbbWV0aG9kTmFtZV0gYXMgeyAoY29uc3RydWN0OiBjZGsuQ29uc3RydWN0KTogdm9pZCB9KShyb2xlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKFwicGVybWlzc2lvbiBvYmplY3RcIiwgcGVybWlzc2lvbik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBzcGVjaWZpZWQgcGVybWlzc2lvbnMgYXJlIG5vdCBzdXBwb3J0ZWQuYCk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gYnVpbGRQb2xpY3koYWN0aW9uOiBzdHJpbmcsIHJlc291cmNlczogc3RyaW5nW10pOiBpYW0uUG9saWN5U3RhdGVtZW50IHtcbiAgcmV0dXJuIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgYWN0aW9uczogW2FjdGlvbl0sXG4gICAgcmVzb3VyY2VzLFxuICB9KTtcbn1cbiJdfQ==