"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Table = exports.TableFieldType = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const dynamodb = __importStar(require("@aws-cdk/aws-dynamodb"));
var TableFieldType;
(function (TableFieldType) {
    TableFieldType["BINARY"] = "B";
    TableFieldType["NUMBER"] = "N";
    TableFieldType["STRING"] = "S";
})(TableFieldType = exports.TableFieldType || (exports.TableFieldType = {}));
/////////////////////
// Construct
/////////////////////
class Table extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { fields, primaryIndex, secondaryIndexes, dynamodbTable } = props;
        ////////////////////
        // Create Table
        ////////////////////
        this.validateFieldsAndIndexes(id, props);
        if (cdk.Construct.isConstruct(dynamodbTable)) {
            // Validate "fields" is not configured
            if (fields !== undefined) {
                throw new Error(`Cannot configure the "fields" when "dynamodbTable" is a construct in the "${id}" Table`);
            }
            this.dynamodbTable = dynamodbTable;
        }
        else {
            let dynamodbTableProps = (dynamodbTable || {});
            // Validate "fields" is configured
            if (fields === undefined) {
                throw new Error(`Missing "fields" in the "${id}" Table`);
            }
            // Validate dynamodbTableProps does not contain "partitionKey" and "sortKey"
            if (dynamodbTableProps.partitionKey) {
                throw new Error(`Cannot configure the "dynamodbTableProps.partitionKey" in the "${id}" Table`);
            }
            if (dynamodbTableProps.sortKey) {
                throw new Error(`Cannot configure the "dynamodbTableProps.sortKey" in the "${id}" Table`);
            }
            if (fields && primaryIndex) {
                dynamodbTableProps = Object.assign(Object.assign({}, dynamodbTableProps), { partitionKey: this.buildAttribute(fields, primaryIndex.partitionKey), sortKey: primaryIndex.sortKey
                        ? this.buildAttribute(fields, primaryIndex.sortKey)
                        : undefined });
            }
            this.dynamodbTable = new dynamodb.Table(this, "Table", Object.assign({ tableName: root.logicalPrefixedName(id), pointInTimeRecovery: true, billingMode: dynamodb.BillingMode.PAY_PER_REQUEST }, dynamodbTableProps));
        }
        //////////////////////////////
        // Create Secondary Indexes
        //////////////////////////////
        if (fields && secondaryIndexes) {
            Object.keys(secondaryIndexes).forEach((indexName) => {
                const { partitionKey, sortKey, indexProps = {} } = secondaryIndexes[indexName];
                // Validate indexProps does not contain "indexName", "partitionKey" and "sortKey"
                if (indexProps.indexName) {
                    throw new Error(`Cannot configure the "indexProps.indexName" in the "${indexName}" index of the "${id}" Table`);
                }
                if (indexProps.partitionKey) {
                    throw new Error(`Cannot configure the "indexProps.partitionKey" in the "${indexName}" index of the "${id}" Table`);
                }
                if (indexProps.sortKey) {
                    throw new Error(`Cannot configure the "indexProps.sortKey" in the "${indexName}" index of the "${id}" Table`);
                }
                this.dynamodbTable.addGlobalSecondaryIndex(Object.assign({ indexName, partitionKey: this.buildAttribute(fields, partitionKey), sortKey: sortKey ? this.buildAttribute(fields, sortKey) : undefined }, indexProps));
            });
        }
    }
    validateFieldsAndIndexes(id, props) {
        const { fields, primaryIndex, secondaryIndexes } = props;
        // Validate "fields"
        if (fields && Object.keys(fields).length === 0) {
            throw new Error(`No fields defined for the "${id}" Table`);
        }
        // Validate "primaryIndex"
        if (primaryIndex && !primaryIndex.partitionKey) {
            throw new Error(`Missing "partitionKey" in primary index for the "${id}" Table`);
        }
        // Validate "fields" and "primaryIndex" co-exists
        if (fields) {
            if (!primaryIndex) {
                throw new Error(`Missing "primaryIndex" in "${id}" Table`);
            }
        }
        else {
            if (primaryIndex) {
                throw new Error(`Cannot configure the "primaryIndex" without setting the "fields" in "${id}" Table`);
            }
            if (secondaryIndexes) {
                throw new Error(`Cannot configure the "secondaryIndexes" without setting the "fields" in "${id}" Table`);
            }
        }
    }
    buildAttribute(fields, name) {
        return {
            name,
            type: this.convertTableFieldTypeToAttributeType(fields[name]),
        };
    }
    convertTableFieldTypeToAttributeType(fieldType) {
        if (fieldType === TableFieldType.BINARY) {
            return dynamodb.AttributeType.BINARY;
        }
        else if (fieldType === TableFieldType.NUMBER) {
            return dynamodb.AttributeType.NUMBER;
        }
        else {
            return dynamodb.AttributeType.STRING;
        }
    }
}
exports.Table = Table;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvVGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1EQUFxQztBQUNyQyxnRUFBa0Q7QUFHbEQsSUFBWSxjQUlYO0FBSkQsV0FBWSxjQUFjO0lBQ3hCLDhCQUFzQyxDQUFBO0lBQ3RDLDhCQUFzQyxDQUFBO0lBQ3RDLDhCQUFzQyxDQUFBO0FBQ3hDLENBQUMsRUFKVyxjQUFjLEdBQWQsc0JBQWMsS0FBZCxzQkFBYyxRQUl6QjtBQTZCRCxxQkFBcUI7QUFDckIsWUFBWTtBQUNaLHFCQUFxQjtBQUVyQixNQUFhLEtBQU0sU0FBUSxHQUFHLENBQUMsU0FBUztJQUd0QyxZQUFZLEtBQW9CLEVBQUUsRUFBVSxFQUFFLEtBQWlCO1FBQzdELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLENBQUM7UUFDcEMsTUFBTSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsZ0JBQWdCLEVBQUUsYUFBYSxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBRXhFLG9CQUFvQjtRQUNwQixlQUFlO1FBQ2Ysb0JBQW9CO1FBRXBCLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFekMsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsRUFBRTtZQUM1QyxzQ0FBc0M7WUFDdEMsSUFBSSxNQUFNLEtBQUssU0FBUyxFQUFFO2dCQUN4QixNQUFNLElBQUksS0FBSyxDQUNiLDZFQUE2RSxFQUFFLFNBQVMsQ0FDekYsQ0FBQzthQUNIO1lBQ0QsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUErQixDQUFDO1NBQ3REO2FBQU07WUFDTCxJQUFJLGtCQUFrQixHQUFHLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBd0Is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IGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQgKiBhcyBkeW5hbW9kYiBmcm9tIFwiQGF3cy1jZGsvYXdzLWR5bmFtb2RiXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcblxuZXhwb3J0IGVudW0gVGFibGVGaWVsZFR5cGUge1xuICBCSU5BUlkgPSBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLkJJTkFSWSxcbiAgTlVNQkVSID0gZHluYW1vZGIuQXR0cmlidXRlVHlwZS5OVU1CRVIsXG4gIFNUUklORyA9IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HLFxufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIEludGVyZmFjZXNcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgaW50ZXJmYWNlIFRhYmxlUHJvcHMge1xuICByZWFkb25seSBmaWVsZHM/OiB7IFtrZXk6IHN0cmluZ106IFRhYmxlRmllbGRUeXBlIH07XG4gIHJlYWRvbmx5IHByaW1hcnlJbmRleD86IFRhYmxlSW5kZXhQcm9wcztcbiAgcmVhZG9ubHkgc2Vjb25kYXJ5SW5kZXhlcz86IHsgW2tleTogc3RyaW5nXTogVGFibGVJbmRleFByb3BzIH07XG4gIHJlYWRvbmx5IGR5bmFtb2RiVGFibGU/OiBkeW5hbW9kYi5JVGFibGUgfCBUYWJsZUNka1Byb3BzO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRhYmxlSW5kZXhQcm9wcyB7XG4gIHJlYWRvbmx5IHBhcnRpdGlvbktleTogc3RyaW5nO1xuICByZWFkb25seSBzb3J0S2V5Pzogc3RyaW5nO1xuICByZWFkb25seSBpbmRleFByb3BzPzogVGFibGVDZGtJbmRleFByb3BzO1xufVxuXG5leHBvcnQgdHlwZSBUYWJsZUNka1Byb3BzID0gT21pdDxcbiAgZHluYW1vZGIuVGFibGVQcm9wcyxcbiAgXCJwYXJ0aXRpb25LZXlcIiB8IFwic29ydEtleVwiXG4+O1xuXG5leHBvcnQgdHlwZSBUYWJsZUNka0luZGV4UHJvcHMgPSBPbWl0PFxuICBkeW5hbW9kYi5HbG9iYWxTZWNvbmRhcnlJbmRleFByb3BzLFxuICBcImluZGV4TmFtZVwiIHwgXCJwYXJ0aXRpb25LZXlcIiB8IFwic29ydEtleVwiXG4+O1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBUYWJsZSBleHRlbmRzIGNkay5Db25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgZHluYW1vZGJUYWJsZTogZHluYW1vZGIuVGFibGU7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBUYWJsZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IHsgZmllbGRzLCBwcmltYXJ5SW5kZXgsIHNlY29uZGFyeUluZGV4ZXMsIGR5bmFtb2RiVGFibGUgfSA9IHByb3BzO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgVGFibGVcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgdGhpcy52YWxpZGF0ZUZpZWxkc0FuZEluZGV4ZXMoaWQsIHByb3BzKTtcblxuICAgIGlmIChjZGsuQ29uc3RydWN0LmlzQ29uc3RydWN0KGR5bmFtb2RiVGFibGUpKSB7XG4gICAgICAvLyBWYWxpZGF0ZSBcImZpZWxkc1wiIGlzIG5vdCBjb25maWd1cmVkXG4gICAgICBpZiAoZmllbGRzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImZpZWxkc1wiIHdoZW4gXCJkeW5hbW9kYlRhYmxlXCIgaXMgYSBjb25zdHJ1Y3QgaW4gdGhlIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZHluYW1vZGJUYWJsZSA9IGR5bmFtb2RiVGFibGUgYXMgZHluYW1vZGIuVGFibGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBkeW5hbW9kYlRhYmxlUHJvcHMgPSAoZHluYW1vZGJUYWJsZSB8fCB7fSkgYXMgZHluYW1vZGIuVGFibGVQcm9wcztcblxuICAgICAgLy8gVmFsaWRhdGUgXCJmaWVsZHNcIiBpcyBjb25maWd1cmVkXG4gICAgICBpZiAoZmllbGRzID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIFwiZmllbGRzXCIgaW4gdGhlIFwiJHtpZH1cIiBUYWJsZWApO1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGF0ZSBkeW5hbW9kYlRhYmxlUHJvcHMgZG9lcyBub3QgY29udGFpbiBcInBhcnRpdGlvbktleVwiIGFuZCBcInNvcnRLZXlcIlxuICAgICAgaWYgKGR5bmFtb2RiVGFibGVQcm9wcy5wYXJ0aXRpb25LZXkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImR5bmFtb2RiVGFibGVQcm9wcy5wYXJ0aXRpb25LZXlcIiBpbiB0aGUgXCIke2lkfVwiIFRhYmxlYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGR5bmFtb2RiVGFibGVQcm9wcy5zb3J0S2V5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJkeW5hbW9kYlRhYmxlUHJvcHMuc29ydEtleVwiIGluIHRoZSBcIiR7aWR9XCIgVGFibGVgXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmIChmaWVsZHMgJiYgcHJpbWFyeUluZGV4KSB7XG4gICAgICAgIGR5bmFtb2RiVGFibGVQcm9wcyA9IHtcbiAgICAgICAgICAuLi5keW5hbW9kYlRhYmxlUHJvcHMsXG4gICAgICAgICAgcGFydGl0aW9uS2V5OiB0aGlzLmJ1aWxkQXR0cmlidXRlKGZpZWxkcywgcHJpbWFyeUluZGV4LnBhcnRpdGlvbktleSksXG4gICAgICAgICAgc29ydEtleTogcHJpbWFyeUluZGV4LnNvcnRLZXlcbiAgICAgICAgICAgID8gdGhpcy5idWlsZEF0dHJpYnV0ZShmaWVsZHMsIHByaW1hcnlJbmRleC5zb3J0S2V5KVxuICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZHluYW1vZGJUYWJsZSA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCBcIlRhYmxlXCIsIHtcbiAgICAgICAgdGFibGVOYW1lOiByb290LmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICBwb2ludEluVGltZVJlY292ZXJ5OiB0cnVlLFxuICAgICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNULFxuICAgICAgICAuLi4oZHluYW1vZGJUYWJsZVByb3BzIGFzIGR5bmFtb2RiLlRhYmxlUHJvcHMpLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIFNlY29uZGFyeSBJbmRleGVzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoZmllbGRzICYmIHNlY29uZGFyeUluZGV4ZXMpIHtcbiAgICAgIE9iamVjdC5rZXlzKHNlY29uZGFyeUluZGV4ZXMpLmZvckVhY2goKGluZGV4TmFtZSkgPT4ge1xuICAgICAgICBjb25zdCB7IHBhcnRpdGlvbktleSwgc29ydEtleSwgaW5kZXhQcm9wcyA9IHt9IH0gPSBzZWNvbmRhcnlJbmRleGVzW1xuICAgICAgICAgIGluZGV4TmFtZVxuICAgICAgICBdO1xuXG4gICAgICAgIC8vIFZhbGlkYXRlIGluZGV4UHJvcHMgZG9lcyBub3QgY29udGFpbiBcImluZGV4TmFtZVwiLCBcInBhcnRpdGlvbktleVwiIGFuZCBcInNvcnRLZXlcIlxuICAgICAgICBpZiAoKGluZGV4UHJvcHMgYXMgZHluYW1vZGIuR2xvYmFsU2Vjb25kYXJ5SW5kZXhQcm9wcykuaW5kZXhOYW1lKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiaW5kZXhQcm9wcy5pbmRleE5hbWVcIiBpbiB0aGUgXCIke2luZGV4TmFtZX1cIiBpbmRleCBvZiB0aGUgXCIke2lkfVwiIFRhYmxlYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKChpbmRleFByb3BzIGFzIGR5bmFtb2RiLkdsb2JhbFNlY29uZGFyeUluZGV4UHJvcHMpLnBhcnRpdGlvbktleSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImluZGV4UHJvcHMucGFydGl0aW9uS2V5XCIgaW4gdGhlIFwiJHtpbmRleE5hbWV9XCIgaW5kZXggb2YgdGhlIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGlmICgoaW5kZXhQcm9wcyBhcyBkeW5hbW9kYi5HbG9iYWxTZWNvbmRhcnlJbmRleFByb3BzKS5zb3J0S2V5KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiaW5kZXhQcm9wcy5zb3J0S2V5XCIgaW4gdGhlIFwiJHtpbmRleE5hbWV9XCIgaW5kZXggb2YgdGhlIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5keW5hbW9kYlRhYmxlLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4KHtcbiAgICAgICAgICBpbmRleE5hbWUsXG4gICAgICAgICAgcGFydGl0aW9uS2V5OiB0aGlzLmJ1aWxkQXR0cmlidXRlKGZpZWxkcywgcGFydGl0aW9uS2V5KSxcbiAgICAgICAgICBzb3J0S2V5OiBzb3J0S2V5ID8gdGhpcy5idWlsZEF0dHJpYnV0ZShmaWVsZHMsIHNvcnRLZXkpIDogdW5kZWZpbmVkLFxuICAgICAgICAgIC4uLmluZGV4UHJvcHMsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgdmFsaWRhdGVGaWVsZHNBbmRJbmRleGVzKGlkOiBzdHJpbmcsIHByb3BzOiBUYWJsZVByb3BzKTogdm9pZCB7XG4gICAgY29uc3QgeyBmaWVsZHMsIHByaW1hcnlJbmRleCwgc2Vjb25kYXJ5SW5kZXhlcyB9ID0gcHJvcHM7XG5cbiAgICAvLyBWYWxpZGF0ZSBcImZpZWxkc1wiXG4gICAgaWYgKGZpZWxkcyAmJiBPYmplY3Qua2V5cyhmaWVsZHMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBmaWVsZHMgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBUYWJsZWApO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIFwicHJpbWFyeUluZGV4XCJcbiAgICBpZiAocHJpbWFyeUluZGV4ICYmICFwcmltYXJ5SW5kZXgucGFydGl0aW9uS2V5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBNaXNzaW5nIFwicGFydGl0aW9uS2V5XCIgaW4gcHJpbWFyeSBpbmRleCBmb3IgdGhlIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgXCJmaWVsZHNcIiBhbmQgXCJwcmltYXJ5SW5kZXhcIiBjby1leGlzdHNcbiAgICBpZiAoZmllbGRzKSB7XG4gICAgICBpZiAoIXByaW1hcnlJbmRleCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgXCJwcmltYXJ5SW5kZXhcIiBpbiBcIiR7aWR9XCIgVGFibGVgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHByaW1hcnlJbmRleCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwicHJpbWFyeUluZGV4XCIgd2l0aG91dCBzZXR0aW5nIHRoZSBcImZpZWxkc1wiIGluIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChzZWNvbmRhcnlJbmRleGVzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJzZWNvbmRhcnlJbmRleGVzXCIgd2l0aG91dCBzZXR0aW5nIHRoZSBcImZpZWxkc1wiIGluIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBidWlsZEF0dHJpYnV0ZShcbiAgICBmaWVsZHM6IHsgW2tleTogc3RyaW5nXTogVGFibGVGaWVsZFR5cGUgfSxcbiAgICBuYW1lOiBzdHJpbmdcbiAgKTogZHluYW1vZGIuQXR0cmlidXRlIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIHR5cGU6IHRoaXMuY29udmVydFRhYmxlRmllbGRUeXBlVG9BdHRyaWJ1dGVUeXBlKGZpZWxkc1tuYW1lXSksXG4gICAgfTtcbiAgfVxuXG4gIGNvbnZlcnRUYWJsZUZpZWxkVHlwZVRvQXR0cmlidXRlVHlwZShcbiAgICBmaWVsZFR5cGU6IFRhYmxlRmllbGRUeXBlXG4gICk6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUge1xuICAgIGlmIChmaWVsZFR5cGUgPT09IFRhYmxlRmllbGRUeXBlLkJJTkFSWSkge1xuICAgICAgcmV0dXJuIGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuQklOQVJZO1xuICAgIH0gZWxzZSBpZiAoZmllbGRUeXBlID09PSBUYWJsZUZpZWxkVHlwZS5OVU1CRVIpIHtcbiAgICAgIHJldHVybiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLk5VTUJFUjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HO1xuICAgIH1cbiAgfVxufVxuIl19