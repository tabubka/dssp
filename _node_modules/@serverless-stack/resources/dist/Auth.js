"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Auth = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const iam = __importStar(require("@aws-cdk/aws-iam"));
const cognito = __importStar(require("@aws-cdk/aws-cognito"));
const permission_1 = require("./util/permission");
class Auth extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { cognito: cognitoProps, cognitoUserPool, cognitoUserPoolClient, auth0, amazon, apple, facebook, google, twitter, } = props;
        ////////////////////
        // Handle Cognito Identity Providers (ie. User Pool)
        ////////////////////
        const cognitoIdentityProviders = [];
        // Validate input
        if (cognitoProps !== undefined && cognitoUserPool !== undefined) {
            throw new Error(`Cannot define both cognito and cognitoUserPool`);
        }
        if (cognitoProps !== undefined && cognitoUserPoolClient !== undefined) {
            throw new Error(`Cannot define both cognito and cognitoUserPoolClient`);
        }
        if ((cognitoUserPool === undefined && cognitoUserPoolClient !== undefined) ||
            (cognitoUserPool !== undefined && cognitoUserPoolClient === undefined)) {
            throw new Error(`Have to define both cognitoUserPool and cognitoUserPoolClient`);
        }
        if (cognitoProps) {
            if (!cognitoProps.signInAliases) {
                throw new Error(`No signInAliases defined for cognito in sst.Auth`);
            }
            // Create User Pool
            this.cognitoUserPool = new cognito.UserPool(this, "UserPool", {
                userPoolName: root.logicalPrefixedName(id),
                selfSignUpEnabled: true,
                signInAliases: cognitoProps.signInAliases,
                signInCaseSensitive: false,
            });
            // Create User Pool Client
            this.cognitoUserPoolClient = new cognito.UserPoolClient(this, "UserPoolClient", {
                userPool: this.cognitoUserPool,
            });
        }
        else if (cognitoUserPool) {
            this.cognitoUserPool = cognitoUserPool;
            this.cognitoUserPoolClient = cognitoUserPoolClient;
        }
        // Set cognito providers
        if (this.cognitoUserPool && this.cognitoUserPoolClient) {
            cognitoIdentityProviders.push({
                providerName: this.cognitoUserPool.userPoolProviderName,
                clientId: this.cognitoUserPoolClient.userPoolClientId,
            });
        }
        ////////////////////
        // Handle OpenId Connect Providers (ie. Auth0)
        ////////////////////
        const openIdConnectProviderArns = [];
        if (auth0) {
            if (!auth0.domain) {
                throw new Error(`No Auth0 domain defined for the "${id}" Auth`);
            }
            if (!auth0.clientId) {
                throw new Error(`No Auth0 clientId defined for the "${id}" Auth`);
            }
            const provider = new iam.OpenIdConnectProvider(this, "Auth0Provider", {
                url: auth0.domain.startsWith("https://")
                    ? auth0.domain
                    : `https://${auth0.domain}`,
                clientIds: [auth0.clientId],
            });
            openIdConnectProviderArns.push(provider.openIdConnectProviderArn);
        }
        ////////////////////
        // Handle Social Identity Providers
        ////////////////////
        const supportedLoginProviders = {};
        if (amazon) {
            if (!amazon.appId) {
                throw new Error(`No Amazon appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["www.amazon.com"] = amazon.appId;
        }
        if (facebook) {
            if (!facebook.appId) {
                throw new Error(`No Facebook appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["graph.facebook.com"] = facebook.appId;
        }
        if (google) {
            if (!google.clientId) {
                throw new Error(`No Google appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["accounts.google.com"] = google.clientId;
        }
        if (twitter) {
            if (!twitter.consumerKey) {
                throw new Error(`No Twitter consumer key defined for the "${id}" Auth`);
            }
            if (!twitter.consumerSecret) {
                throw new Error(`No Twitter consumer secret defined for the "${id}" Auth`);
            }
            supportedLoginProviders["api.twitter.com"] = `${twitter.consumerKey};${twitter.consumerSecret}`;
        }
        if (apple) {
            if (!apple.servicesId) {
                throw new Error(`No Apple servicesId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["appleid.apple.com"] = apple.servicesId;
        }
        ////////////////////
        // Create Identity Pool
        ////////////////////
        // Create Cognito Identity Pool
        this.cognitoCfnIdentityPool = new cognito.CfnIdentityPool(this, "IdentityPool", {
            identityPoolName: root.logicalPrefixedName(id),
            allowUnauthenticatedIdentities: true,
            cognitoIdentityProviders,
            supportedLoginProviders,
            openIdConnectProviderArns,
        });
        this.iamAuthRole = this.createAuthRole(this.cognitoCfnIdentityPool);
        this.iamUnauthRole = this.createUnauthRole(this.cognitoCfnIdentityPool);
        // Attach roles to Identity Pool
        new cognito.CfnIdentityPoolRoleAttachment(this, "IdentityPoolRoleAttachment", {
            identityPoolId: this.cognitoCfnIdentityPool.ref,
            roles: {
                authenticated: this.iamAuthRole.roleArn,
                unauthenticated: this.iamUnauthRole.roleArn,
            },
        });
    }
    createAuthRole(identityPool) {
        const role = new iam.Role(this, "IdentityPoolAuthRole", {
            assumedBy: new iam.FederatedPrincipal("cognito-identity.amazonaws.com", {
                StringEquals: {
                    "cognito-identity.amazonaws.com:aud": identityPool.ref,
                },
                "ForAnyValue:StringLike": {
                    "cognito-identity.amazonaws.com:amr": "authenticated",
                },
            }, "sts:AssumeRoleWithWebIdentity"),
        });
        role.addToPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "mobileanalytics:PutEvents",
                "cognito-sync:*",
                "cognito-identity:*",
            ],
            resources: ["*"],
        }));
        return role;
    }
    createUnauthRole(identityPool) {
        const role = new iam.Role(this, "IdentityPoolUnauthRole", {
            assumedBy: new iam.FederatedPrincipal("cognito-identity.amazonaws.com", {
                StringEquals: {
                    "cognito-identity.amazonaws.com:aud": identityPool.ref,
                },
                "ForAnyValue:StringLike": {
                    "cognito-identity.amazonaws.com:amr": "unauthenticated",
                },
            }, "sts:AssumeRoleWithWebIdentity"),
        });
        role.addToPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["mobileanalytics:PutEvents", "cognito-sync:*"],
            resources: ["*"],
        }));
        return role;
    }
    attachPermissionsForAuthUsers(permissions) {
        permission_1.attachPermissionsToRole(this.iamAuthRole, permissions);
    }
    attachPermissionsForUnauthUsers(permissions) {
        permission_1.attachPermissionsToRole(this.iamUnauthRole, permissions);
    }
}
exports.Auth = Auth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9BdXRoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxtREFBcUM7QUFDckMsc0RBQXdDO0FBQ3hDLDhEQUFnRDtBQUdoRCxrREFBeUU7QUE0Q3pFLE1BQWEsSUFBSyxTQUFRLEdBQUcsQ0FBQyxTQUFTO0lBT3JDLFlBQVksS0FBb0IsRUFBRSxFQUFVLEVBQUUsS0FBZ0I7UUFDNUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxNQUFNLEVBQ0osT0FBTyxFQUFFLFlBQVksRUFDckIsZUFBZSxFQUNmLHFCQUFxQixFQUNyQixLQUFLLEVBQ0wsTUFBTSxFQUNOLEtBQUssRUFDTCxRQUFRLEVBQ1IsTUFBTSxFQUNOLE9BQU8sR0FDUixHQUFHLEtBQUssQ0FBQztRQUVWLG9CQUFvQjtRQUNwQixvREFBb0Q7UUFDcEQsb0JBQW9CO1FBQ3BCLE1BQU0sd0JBQXdCLEdBQUcsRUFBRSxDQUFDO1FBRXBDLGlCQUFpQjtRQUNqQixJQUFJLFlBQVksS0FBSyxTQUFTLElBQUksZUFBZSxLQUFLLFNBQVMsRUFBRTtZQUMvRCxNQUFNLElBQUksS0FBSyxDQUFDLGdEQUFnRCxDQUFDLENBQUM7U0FDbkU7UUFDRCxJQUFJLFlBQVksS0FBSyxTQUFTLElBQUkscUJBQXFCLEtBQUssU0FBUyxFQUFFO1lBQ3JFLE1BQU0sSUFBSSxLQUFLLENBQUMsc0RBQXNELENBQUMsQ0FBQztTQUN6RTtRQUNELElBQ0UsQ0FBQyxlQUFlLEtBQUssU0FBUyxJQUFJLHFCQUFxQixLQUFLLFNBQVMsQ0FBQztZQUN0RSxDQUFDLGVBQWUsS0FBSyxTQUFTLElBQUkscUJBQXFCLEtBQUssU0FBUyxDQUFDLEVBQ3RFO1lBQ0EsTUFBTSxJQUFJLEtBQUssQ0FDYiwr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LENBQ0gsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELGdCQUFnQixDQUFDLFlBQXFDO1FBQ3BELE1BQU0sSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsd0JBQXdCLEVBQUU7WUFDeEQsU0FBUyxFQUFFLElBQUksR0FBRyxDQUFDLGtCQUFrQixDQUNuQyxnQ0FBZ0MsRUFDaEM7Z0JBQ0UsWUFBWSxFQUFFO29CQUNaLG9DQUFvQyxFQUFFLFlBQVksQ0FBQyxHQUFHO2lCQUN2RDtnQkFDRCx3QkFBd0IsRUFBRTtvQkFDeEIsb0NBQW9DLEVBQUUsaUJBQWlCO2lCQUN4RDthQUNGLEVBQ0QsK0JBQStCLENBQ2hDO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFdBQVcsQ0FDZCxJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDdEIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztZQUN4QixPQUFPLEVBQUUsQ0FBQywyQkFBMkIsRUFBRSxnQkFBZ0IsQ0FBQztZQUN4RCxTQUFTLEVBQUUsQ0FBQyxHQUFHLENBQUM7U0FDakIsQ0FBQyxDQUNILENBQUM7UUFFRixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCw2QkFBNkIsQ0FBQyxXQUF3QjtRQUNwRCxvQ0FBdUIsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFRCwrQkFBK0IsQ0FBQyxXQUF3QjtRQUN0RCxvQ0FBdUIsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQzNELENBQUM7Q0FDRjtBQWhQRCxvQkFnUEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSBcIkBhd3MtY2RrL2NvcmVcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiQGF3cy1jZGsvYXdzLWlhbVwiO1xuaW1wb3J0ICogYXMgY29nbml0byBmcm9tIFwiQGF3cy1jZGsvYXdzLWNvZ25pdG9cIjtcblxuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucywgYXR0YWNoUGVybWlzc2lvbnNUb1JvbGUgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuZXhwb3J0IGludGVyZmFjZSBBdXRoUHJvcHMge1xuICByZWFkb25seSBjb2duaXRvPzogQXV0aENvZ25pdG9Qcm9wcztcbiAgcmVhZG9ubHkgY29nbml0b1VzZXJQb29sPzogY29nbml0by5JVXNlclBvb2w7XG4gIHJlYWRvbmx5IGNvZ25pdG9Vc2VyUG9vbENsaWVudD86IGNvZ25pdG8uSVVzZXJQb29sQ2xpZW50O1xuICByZWFkb25seSBhdXRoMD86IEF1dGhBdXRoMFByb3BzO1xuICByZWFkb25seSBhbWF6b24/OiBBdXRoQW1hem9uUHJvcHM7XG4gIHJlYWRvbmx5IGFwcGxlPzogQXV0aEFwcGxlUHJvcHM7XG4gIHJlYWRvbmx5IGZhY2Vib29rPzogQXV0aEZhY2Vib29rUHJvcHM7XG4gIHJlYWRvbmx5IGdvb2dsZT86IEF1dGhHb29nbGVQcm9wcztcbiAgcmVhZG9ubHkgdHdpdHRlcj86IEF1dGhUd2l0dGVyUHJvcHM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aENvZ25pdG9Qcm9wcyB7XG4gIHJlYWRvbmx5IHNpZ25JbkFsaWFzZXM6IGNvZ25pdG8uU2lnbkluQWxpYXNlcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoQXV0aDBQcm9wcyB7XG4gIHJlYWRvbmx5IGRvbWFpbjogc3RyaW5nO1xuICByZWFkb25seSBjbGllbnRJZDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhBbWF6b25Qcm9wcyB7XG4gIHJlYWRvbmx5IGFwcElkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aEFwcGxlUHJvcHMge1xuICByZWFkb25seSBzZXJ2aWNlc0lkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aEZhY2Vib29rUHJvcHMge1xuICByZWFkb25seSBhcHBJZDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhHb29nbGVQcm9wcyB7XG4gIHJlYWRvbmx5IGNsaWVudElkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aFR3aXR0ZXJQcm9wcyB7XG4gIHJlYWRvbmx5IGNvbnN1bWVyS2V5OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGNvbnN1bWVyU2VjcmV0OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBBdXRoIGV4dGVuZHMgY2RrLkNvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBjb2duaXRvVXNlclBvb2w/OiBjb2duaXRvLlVzZXJQb29sO1xuICBwdWJsaWMgcmVhZG9ubHkgY29nbml0b1VzZXJQb29sQ2xpZW50PzogY29nbml0by5Vc2VyUG9vbENsaWVudDtcbiAgcHVibGljIHJlYWRvbmx5IGNvZ25pdG9DZm5JZGVudGl0eVBvb2w6IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sO1xuICBwdWJsaWMgcmVhZG9ubHkgaWFtQXV0aFJvbGU6IGlhbS5Sb2xlO1xuICBwdWJsaWMgcmVhZG9ubHkgaWFtVW5hdXRoUm9sZTogaWFtLlJvbGU7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBBdXRoUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3Qge1xuICAgICAgY29nbml0bzogY29nbml0b1Byb3BzLFxuICAgICAgY29nbml0b1VzZXJQb29sLFxuICAgICAgY29nbml0b1VzZXJQb29sQ2xpZW50LFxuICAgICAgYXV0aDAsXG4gICAgICBhbWF6b24sXG4gICAgICBhcHBsZSxcbiAgICAgIGZhY2Vib29rLFxuICAgICAgZ29vZ2xlLFxuICAgICAgdHdpdHRlcixcbiAgICB9ID0gcHJvcHM7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEhhbmRsZSBDb2duaXRvIElkZW50aXR5IFByb3ZpZGVycyAoaWUuIFVzZXIgUG9vbClcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IGNvZ25pdG9JZGVudGl0eVByb3ZpZGVycyA9IFtdO1xuXG4gICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICBpZiAoY29nbml0b1Byb3BzICE9PSB1bmRlZmluZWQgJiYgY29nbml0b1VzZXJQb29sICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGRlZmluZSBib3RoIGNvZ25pdG8gYW5kIGNvZ25pdG9Vc2VyUG9vbGApO1xuICAgIH1cbiAgICBpZiAoY29nbml0b1Byb3BzICE9PSB1bmRlZmluZWQgJiYgY29nbml0b1VzZXJQb29sQ2xpZW50ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGRlZmluZSBib3RoIGNvZ25pdG8gYW5kIGNvZ25pdG9Vc2VyUG9vbENsaWVudGApO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICAoY29nbml0b1VzZXJQb29sID09PSB1bmRlZmluZWQgJiYgY29nbml0b1VzZXJQb29sQ2xpZW50ICE9PSB1bmRlZmluZWQpIHx8XG4gICAgICAoY29nbml0b1VzZXJQb29sICE9PSB1bmRlZmluZWQgJiYgY29nbml0b1VzZXJQb29sQ2xpZW50ID09PSB1bmRlZmluZWQpXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBIYXZlIHRvIGRlZmluZSBib3RoIGNvZ25pdG9Vc2VyUG9vbCBhbmQgY29nbml0b1VzZXJQb29sQ2xpZW50YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoY29nbml0b1Byb3BzKSB7XG4gICAgICBpZiAoIWNvZ25pdG9Qcm9wcy5zaWduSW5BbGlhc2VzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gc2lnbkluQWxpYXNlcyBkZWZpbmVkIGZvciBjb2duaXRvIGluIHNzdC5BdXRoYCk7XG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSBVc2VyIFBvb2xcbiAgICAgIHRoaXMuY29nbml0b1VzZXJQb29sID0gbmV3IGNvZ25pdG8uVXNlclBvb2wodGhpcywgXCJVc2VyUG9vbFwiLCB7XG4gICAgICAgIHVzZXJQb29sTmFtZTogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgc2VsZlNpZ25VcEVuYWJsZWQ6IHRydWUsXG4gICAgICAgIHNpZ25JbkFsaWFzZXM6IGNvZ25pdG9Qcm9wcy5zaWduSW5BbGlhc2VzLFxuICAgICAgICBzaWduSW5DYXNlU2Vuc2l0aXZlOiBmYWxzZSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDcmVhdGUgVXNlciBQb29sIENsaWVudFxuICAgICAgdGhpcy5jb2duaXRvVXNlclBvb2xDbGllbnQgPSBuZXcgY29nbml0by5Vc2VyUG9vbENsaWVudChcbiAgICAgICAgdGhpcyxcbiAgICAgICAgXCJVc2VyUG9vbENsaWVudFwiLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2w6IHRoaXMuY29nbml0b1VzZXJQb29sLFxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAoY29nbml0b1VzZXJQb29sKSB7XG4gICAgICB0aGlzLmNvZ25pdG9Vc2VyUG9vbCA9IGNvZ25pdG9Vc2VyUG9vbCBhcyBjb2duaXRvLlVzZXJQb29sO1xuICAgICAgdGhpcy5jb2duaXRvVXNlclBvb2xDbGllbnQgPSBjb2duaXRvVXNlclBvb2xDbGllbnQgYXMgY29nbml0by5Vc2VyUG9vbENsaWVudDtcbiAgICB9XG5cbiAgICAvLyBTZXQgY29nbml0byBwcm92aWRlcnNcbiAgICBpZiAodGhpcy5jb2duaXRvVXNlclBvb2wgJiYgdGhpcy5jb2duaXRvVXNlclBvb2xDbGllbnQpIHtcbiAgICAgIGNvZ25pdG9JZGVudGl0eVByb3ZpZGVycy5wdXNoKHtcbiAgICAgICAgcHJvdmlkZXJOYW1lOiB0aGlzLmNvZ25pdG9Vc2VyUG9vbC51c2VyUG9vbFByb3ZpZGVyTmFtZSxcbiAgICAgICAgY2xpZW50SWQ6IHRoaXMuY29nbml0b1VzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEhhbmRsZSBPcGVuSWQgQ29ubmVjdCBQcm92aWRlcnMgKGllLiBBdXRoMClcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IG9wZW5JZENvbm5lY3RQcm92aWRlckFybnMgPSBbXTtcblxuICAgIGlmIChhdXRoMCkge1xuICAgICAgaWYgKCFhdXRoMC5kb21haW4pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBBdXRoMCBkb21haW4gZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYCk7XG4gICAgICB9XG4gICAgICBpZiAoIWF1dGgwLmNsaWVudElkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gQXV0aDAgY2xpZW50SWQgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYCk7XG4gICAgICB9XG4gICAgICBjb25zdCBwcm92aWRlciA9IG5ldyBpYW0uT3BlbklkQ29ubmVjdFByb3ZpZGVyKHRoaXMsIFwiQXV0aDBQcm92aWRlclwiLCB7XG4gICAgICAgIHVybDogYXV0aDAuZG9tYWluLnN0YXJ0c1dpdGgoXCJodHRwczovL1wiKVxuICAgICAgICAgID8gYXV0aDAuZG9tYWluXG4gICAgICAgICAgOiBgaHR0cHM6Ly8ke2F1dGgwLmRvbWFpbn1gLFxuICAgICAgICBjbGllbnRJZHM6IFthdXRoMC5jbGllbnRJZF0sXG4gICAgICB9KTtcbiAgICAgIG9wZW5JZENvbm5lY3RQcm92aWRlckFybnMucHVzaChwcm92aWRlci5vcGVuSWRDb25uZWN0UHJvdmlkZXJBcm4pO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gSGFuZGxlIFNvY2lhbCBJZGVudGl0eSBQcm92aWRlcnNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzID0ge30gYXMgeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcblxuICAgIGlmIChhbWF6b24pIHtcbiAgICAgIGlmICghYW1hem9uLmFwcElkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gQW1hem9uIGFwcElkIGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbXCJ3d3cuYW1hem9uLmNvbVwiXSA9IGFtYXpvbi5hcHBJZDtcbiAgICB9XG4gICAgaWYgKGZhY2Vib29rKSB7XG4gICAgICBpZiAoIWZhY2Vib29rLmFwcElkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gRmFjZWJvb2sgYXBwSWQgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYCk7XG4gICAgICB9XG4gICAgICBzdXBwb3J0ZWRMb2dpblByb3ZpZGVyc1tcImdyYXBoLmZhY2Vib29rLmNvbVwiXSA9IGZhY2Vib29rLmFwcElkO1xuICAgIH1cbiAgICBpZiAoZ29vZ2xlKSB7XG4gICAgICBpZiAoIWdvb2dsZS5jbGllbnRJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIEdvb2dsZSBhcHBJZCBkZWZpbmVkIGZvciB0aGUgXCIke2lkfVwiIEF1dGhgKTtcbiAgICAgIH1cbiAgICAgIHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzW1wiYWNjb3VudHMuZ29vZ2xlLmNvbVwiXSA9IGdvb2dsZS5jbGllbnRJZDtcbiAgICB9XG4gICAgaWYgKHR3aXR0ZXIpIHtcbiAgICAgIGlmICghdHdpdHRlci5jb25zdW1lcktleSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIFR3aXR0ZXIgY29uc3VtZXIga2V5IGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgaWYgKCF0d2l0dGVyLmNvbnN1bWVyU2VjcmV0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgTm8gVHdpdHRlciBjb25zdW1lciBzZWNyZXQgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbXG4gICAgICAgIFwiYXBpLnR3aXR0ZXIuY29tXCJcbiAgICAgIF0gPSBgJHt0d2l0dGVyLmNvbnN1bWVyS2V5fTske3R3aXR0ZXIuY29uc3VtZXJTZWNyZXR9YDtcbiAgICB9XG4gICAgaWYgKGFwcGxlKSB7XG4gICAgICBpZiAoIWFwcGxlLnNlcnZpY2VzSWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBBcHBsZSBzZXJ2aWNlc0lkIGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbXCJhcHBsZWlkLmFwcGxlLmNvbVwiXSA9IGFwcGxlLnNlcnZpY2VzSWQ7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgSWRlbnRpdHkgUG9vbFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAvLyBDcmVhdGUgQ29nbml0byBJZGVudGl0eSBQb29sXG4gICAgdGhpcy5jb2duaXRvQ2ZuSWRlbnRpdHlQb29sID0gbmV3IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sKFxuICAgICAgdGhpcyxcbiAgICAgIFwiSWRlbnRpdHlQb29sXCIsXG4gICAgICB7XG4gICAgICAgIGlkZW50aXR5UG9vbE5hbWU6IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAgIGFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllczogdHJ1ZSxcbiAgICAgICAgY29nbml0b0lkZW50aXR5UHJvdmlkZXJzLFxuICAgICAgICBzdXBwb3J0ZWRMb2dpblByb3ZpZGVycyxcbiAgICAgICAgb3BlbklkQ29ubmVjdFByb3ZpZGVyQXJucyxcbiAgICAgIH1cbiAgICApO1xuICAgIHRoaXMuaWFtQXV0aFJvbGUgPSB0aGlzLmNyZWF0ZUF1dGhSb2xlKHRoaXMuY29nbml0b0NmbklkZW50aXR5UG9vbCk7XG4gICAgdGhpcy5pYW1VbmF1dGhSb2xlID0gdGhpcy5jcmVhdGVVbmF1dGhSb2xlKHRoaXMuY29nbml0b0NmbklkZW50aXR5UG9vbCk7XG5cbiAgICAvLyBBdHRhY2ggcm9sZXMgdG8gSWRlbnRpdHkgUG9vbFxuICAgIG5ldyBjb2duaXRvLkNmbklkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50KFxuICAgICAgdGhpcyxcbiAgICAgIFwiSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnRcIixcbiAgICAgIHtcbiAgICAgICAgaWRlbnRpdHlQb29sSWQ6IHRoaXMuY29nbml0b0NmbklkZW50aXR5UG9vbC5yZWYsXG4gICAgICAgIHJvbGVzOiB7XG4gICAgICAgICAgYXV0aGVudGljYXRlZDogdGhpcy5pYW1BdXRoUm9sZS5yb2xlQXJuLFxuICAgICAgICAgIHVuYXV0aGVudGljYXRlZDogdGhpcy5pYW1VbmF1dGhSb2xlLnJvbGVBcm4sXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGNyZWF0ZUF1dGhSb2xlKGlkZW50aXR5UG9vbDogY29nbml0by5DZm5JZGVudGl0eVBvb2wpOiBpYW0uUm9sZSB7XG4gICAgY29uc3Qgcm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCBcIklkZW50aXR5UG9vbEF1dGhSb2xlXCIsIHtcbiAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5GZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tXCIsXG4gICAgICAgIHtcbiAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZFwiOiBpZGVudGl0eVBvb2wucmVmLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgXCJGb3JBbnlWYWx1ZTpTdHJpbmdMaWtlXCI6IHtcbiAgICAgICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmFtclwiOiBcImF1dGhlbnRpY2F0ZWRcIixcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBcInN0czpBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5XCJcbiAgICAgICksXG4gICAgfSk7XG5cbiAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICBcIm1vYmlsZWFuYWx5dGljczpQdXRFdmVudHNcIixcbiAgICAgICAgICBcImNvZ25pdG8tc3luYzoqXCIsXG4gICAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5OipcIixcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmV0dXJuIHJvbGU7XG4gIH1cblxuICBjcmVhdGVVbmF1dGhSb2xlKGlkZW50aXR5UG9vbDogY29nbml0by5DZm5JZGVudGl0eVBvb2wpOiBpYW0uUm9sZSB7XG4gICAgY29uc3Qgcm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCBcIklkZW50aXR5UG9vbFVuYXV0aFJvbGVcIiwge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLkZlZGVyYXRlZFByaW5jaXBhbChcbiAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb21cIixcbiAgICAgICAge1xuICAgICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YXVkXCI6IGlkZW50aXR5UG9vbC5yZWYsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBcIkZvckFueVZhbHVlOlN0cmluZ0xpa2VcIjoge1xuICAgICAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yXCI6IFwidW5hdXRoZW50aWNhdGVkXCIsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgXCJzdHM6QXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eVwiXG4gICAgICApLFxuICAgIH0pO1xuXG4gICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbXCJtb2JpbGVhbmFseXRpY3M6UHV0RXZlbnRzXCIsIFwiY29nbml0by1zeW5jOipcIl0sXG4gICAgICAgIHJlc291cmNlczogW1wiKlwiXSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHJldHVybiByb2xlO1xuICB9XG5cbiAgYXR0YWNoUGVybWlzc2lvbnNGb3JBdXRoVXNlcnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgYXR0YWNoUGVybWlzc2lvbnNUb1JvbGUodGhpcy5pYW1BdXRoUm9sZSwgcGVybWlzc2lvbnMpO1xuICB9XG5cbiAgYXR0YWNoUGVybWlzc2lvbnNGb3JVbmF1dGhVc2VycyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBhdHRhY2hQZXJtaXNzaW9uc1RvUm9sZSh0aGlzLmlhbVVuYXV0aFJvbGUsIHBlcm1pc3Npb25zKTtcbiAgfVxufVxuIl19