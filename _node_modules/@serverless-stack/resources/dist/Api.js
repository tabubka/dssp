"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Api = exports.ApiPayloadFormatVersion = exports.ApiAuthorizationType = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const logs = __importStar(require("@aws-cdk/aws-logs"));
const route53 = __importStar(require("@aws-cdk/aws-route53"));
const route53Targets = __importStar(require("@aws-cdk/aws-route53-targets"));
const acm = __importStar(require("@aws-cdk/aws-certificatemanager"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2"));
const apigIntegrations = __importStar(require("@aws-cdk/aws-apigatewayv2-integrations"));
const Function_1 = require("./Function");
const allowedMethods = [
    apig.HttpMethod.ANY,
    apig.HttpMethod.GET,
    apig.HttpMethod.PUT,
    apig.HttpMethod.POST,
    apig.HttpMethod.HEAD,
    apig.HttpMethod.PATCH,
    apig.HttpMethod.DELETE,
    apig.HttpMethod.OPTIONS,
];
var ApiAuthorizationType;
(function (ApiAuthorizationType) {
    ApiAuthorizationType["JWT"] = "JWT";
    ApiAuthorizationType["NONE"] = "NONE";
    ApiAuthorizationType["AWS_IAM"] = "AWS_IAM";
})(ApiAuthorizationType = exports.ApiAuthorizationType || (exports.ApiAuthorizationType = {}));
var ApiPayloadFormatVersion;
(function (ApiPayloadFormatVersion) {
    ApiPayloadFormatVersion["V1"] = "1.0";
    ApiPayloadFormatVersion["V2"] = "2.0";
})(ApiPayloadFormatVersion = exports.ApiPayloadFormatVersion || (exports.ApiPayloadFormatVersion = {}));
/////////////////////
// Construct
/////////////////////
class Api extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { httpApi, routes, cors, accessLog, customDomain, defaultFunctionProps, defaultAuthorizer, defaultAuthorizationType, defaultAuthorizationScopes, defaultPayloadFormatVersion, } = props || {};
        this.functions = {};
        this.permissionsAttachedForAllRoutes = [];
        this.defaultFunctionProps = defaultFunctionProps;
        this.defaultAuthorizer = defaultAuthorizer;
        this.defaultAuthorizationType = defaultAuthorizationType;
        this.defaultAuthorizationScopes = defaultAuthorizationScopes;
        this.defaultPayloadFormatVersion = defaultPayloadFormatVersion;
        ////////////////////
        // Create Api
        ////////////////////
        if (cdk.Construct.isConstruct(httpApi)) {
            if (cors !== undefined) {
                throw new Error(`Cannot configure the "cors" when "httpApi" is a construct`);
            }
            if (accessLog !== undefined) {
                throw new Error(`Cannot configure the "accessLog" when "httpApi" is a construct`);
            }
            if (customDomain !== undefined) {
                throw new Error(`Cannot configure the "customDomain" when "httpApi" is a construct`);
            }
            this.httpApi = httpApi;
        }
        else {
            const httpApiProps = (httpApi || {});
            // Validate input
            if (httpApiProps.corsPreflight !== undefined) {
                throw new Error(`Cannot configure the "httpApi.corsPreflight" in the Api`);
            }
            if (httpApiProps.defaultDomainMapping !== undefined) {
                throw new Error(`Cannot configure the "httpApi.defaultDomainMapping" in the Api`);
            }
            const corsPreflight = this.buildCorsConfig(cors);
            const defaultDomainMapping = this.buildCustomDomainConfig(customDomain);
            this.httpApi = new apig.HttpApi(this, "Api", Object.assign({ apiName: root.logicalPrefixedName(id), corsPreflight,
                defaultDomainMapping }, httpApiProps));
            this.accessLogGroup = this.buildAccessLogConfig(accessLog);
        }
        ///////////////////////////
        // Configure routes
        ///////////////////////////
        this.addRoutes(this, routes || {});
    }
    buildCorsConfig(cors) {
        // Handle cors: false
        if (cors === false) {
            return;
        }
        // Handle cors: true | undefined
        else if (cors === undefined || cors === true) {
            // We want CORS to allow all methods, however
            // - if we set allowMethods to ["*"], type check would fail b/c allowMethods
            //   is exptected to take an array of HttpMethod, not "*"
            // - if we set allowMethod to all allowedMethods, CloudFormation will fail
            //   b/c ANY is not acceptable.
            // So, we filter out ANY from allowedMethods. See CDK issue -
            // https://github.com/aws/aws-cdk/issues/10230
            return {
                allowHeaders: ["*"],
                allowMethods: allowedMethods.filter((m) => m !== apig.HttpMethod.ANY),
                allowOrigins: ["*"],
            };
        }
        // Handle cors: apig.CorsPreflightOptions
        else {
            return cors;
        }
    }
    buildCustomDomainConfig(customDomain) {
        if (customDomain === undefined) {
            return;
        }
        // To be implemented: to allow more flexible use cases, SST should support two more use cases:
        //  1. Allow user passing in `hostedZone` object. The use case is when there are multiple
        //     HostedZones with the same domain, but one is public, and one is private.
        //  2. Allow user passing in `certificate` object. The use case is for user to create wildcard
        //     certificate or using an imported certificate.
        //  3. Allow user passing in `apigDomain` object. The use case is a user creates multiple API
        //     endpoints, and is mapping them under the same custom domain. `sst.Api` needs to expose the
        //     `apigDomain` construct created in the first Api, and lets user pass it in when creating
        //     the second Api.
        let domainName, hostedZone, hostedZoneDomain, certificate, apigDomain, mappingKey;
        // customDomain passed in as a string
        if (typeof customDomain === "string") {
            domainName = customDomain;
            hostedZoneDomain = customDomain.split(".").slice(1).join(".");
        }
        // customDomain passed in as an object
        else {
            if (!customDomain.domainName) {
                throw new Error(`Missing "domainName" in sst.Api's customDomain setting`);
            }
            // parse customDomain.domainName
            if (typeof customDomain.domainName === "string") {
                domainName = customDomain.domainName;
            }
            else {
                apigDomain = customDomain.domainName;
                if (customDomain.hostedZone) {
                    throw new Error(`Cannot configure the "hostedZone" when the "domainName" is a construct`);
                }
                if (customDomain.certificate) {
                    throw new Error(`Cannot configure the "certificate" when the "domainName" is a construct`);
                }
            }
            // parse customDomain.hostedZone
            if (!apigDomain) {
                if (!customDomain.hostedZone) {
                    hostedZoneDomain = domainName
                        .split(".")
                        .slice(1)
                        .join(".");
                }
                else if (typeof customDomain.hostedZone === "string") {
                    hostedZoneDomain = customDomain.hostedZone;
                }
                else {
                    hostedZone = customDomain.hostedZone;
                }
            }
            certificate = customDomain.certificate;
            mappingKey = customDomain.path;
        }
        if (!apigDomain && domainName) {
            // Look up hosted zone
            if (!hostedZone && hostedZoneDomain) {
                hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                    domainName: hostedZoneDomain,
                });
            }
            if (!hostedZone) {
                throw new Error(`Cannot find hosted zone "${hostedZoneDomain}" in Route 53`);
            }
            // Create certificate
            if (!certificate) {
                certificate = new acm.Certificate(this, "Certificate", {
                    domainName,
                    validation: acm.CertificateValidation.fromDns(hostedZone),
                });
            }
            // Create custom domain in API Gateway
            apigDomain = new apig.DomainName(this, "DomainName", {
                domainName,
                certificate,
            });
            // Create DNS record
            new route53.ARecord(this, "AliasRecord", {
                recordName: domainName,
                zone: hostedZone,
                target: route53.RecordTarget.fromAlias(new route53Targets.ApiGatewayv2Domain(apigDomain)),
            });
        }
        return {
            domainName: apigDomain,
            mappingKey,
        };
    }
    buildAccessLogConfig(accessLog) {
        var _a;
        if (accessLog === false) {
            return;
        }
        // note: Access log configuration is not supported by L2 constructs as of CDK v1.85.0. We
        //       need to define it at L1 construct level.
        // create log group
        let logGroup;
        let destinationArn;
        if (accessLog &&
            accessLog.destinationArn) {
            destinationArn = accessLog
                .destinationArn;
        }
        else {
            logGroup = new logs.LogGroup(this, "LogGroup");
            destinationArn = logGroup.logGroupArn;
        }
        // get log format
        let format;
        if (accessLog &&
            accessLog.format) {
            format = accessLog.format;
        }
        else if (typeof accessLog === "string") {
            format = accessLog;
        }
        else {
            format = JSON.stringify({
                // request info
                requestTime: "$context.requestTime",
                requestId: "$context.requestId",
                httpMethod: "$context.httpMethod",
                path: "$context.path",
                routeKey: "$context.routeKey",
                status: "$context.status",
                responseLatency: "$context.responseLatency",
                // integration info
                integrationRequestId: "$context.integration.requestId",
                integrationStatus: "$context.integration.status",
                integrationLatency: "$context.integration.latency",
                integrationServiceStatus: "$context.integration.integrationStatus",
                // caller info
                ip: "$context.identity.sourceIp",
                userAgent: "$context.identity.userAgent",
                cognitoIdentityId: "$context.identity.cognitoIdentityId",
            });
        }
        // get L1 cfnStage construct
        if (!((_a = this.httpApi.defaultStage) === null || _a === void 0 ? void 0 : _a.node.defaultChild)) {
            throw new Error(`Failed to define the default stage for Http API`);
        }
        // set access log settings
        const cfnStage = this.httpApi.defaultStage.node
            .defaultChild;
        cfnStage.accessLogSettings = { format, destinationArn };
        return logGroup;
    }
    addRoutes(scope, routes) {
        Object.keys(routes).forEach((routeKey) => {
            // add route
            const fn = this.addRoute(scope, routeKey, routes[routeKey]);
            // attached existing permissions
            this.permissionsAttachedForAllRoutes.forEach((permissions) => fn.attachPermissions(permissions));
        });
    }
    addRoute(scope, routeKey, routeValue) {
        // Normalize routeProps
        const routeProps = (this.isInstanceOfApiRouteProps(routeValue)
            ? routeValue
            : { function: routeValue });
        // Normalize routeKey
        routeKey = this.normalizeRouteKey(routeKey);
        ///////////////////
        // Get path and method
        ///////////////////
        const routeKeyParts = routeKey.split(" ");
        if (routeKeyParts.length !== 2) {
            throw new Error(`Invalid route ${routeKey}`);
        }
        const methodStr = routeKeyParts[0].toUpperCase();
        const path = routeKeyParts[1];
        const method = allowedMethods.find((per) => per === methodStr);
        if (!method) {
            throw new Error(`Invalid method defined for "${routeKey}"`);
        }
        if (path.length === 0) {
            throw new Error(`Invalid path defined for "${routeKey}"`);
        }
        ///////////////////
        // Get authorization
        ///////////////////
        const authorizationType = routeProps.authorizationType ||
            this.defaultAuthorizationType ||
            ApiAuthorizationType.NONE;
        if (!Object.values(ApiAuthorizationType).includes(authorizationType)) {
            throw new Error(`sst.Api does not currently support ${authorizationType}. Only "AWS_IAM" and "JWT" are currently supported.`);
        }
        let authorizer, authorizationScopes;
        if (authorizationType === ApiAuthorizationType.JWT) {
            authorizer = routeProps.authorizer || this.defaultAuthorizer;
            authorizationScopes =
                routeProps.authorizationScopes || this.defaultAuthorizationScopes;
        }
        if (authorizationType === ApiAuthorizationType.JWT && !authorizer) {
            throw new Error(`Missing JWT authorizer for "${routeKey}"`);
        }
        ///////////////////
        // Get payload format
        ///////////////////
        const payloadFormatVersion = routeProps.payloadFormatVersion ||
            this.defaultPayloadFormatVersion ||
            ApiPayloadFormatVersion.V2;
        if (!Object.values(ApiPayloadFormatVersion).includes(payloadFormatVersion)) {
            throw new Error(`sst.Api does not currently support ${payloadFormatVersion} payload format version. Only "V1" and "V2" are currently supported.`);
        }
        const integrationPayloadFormatVersion = payloadFormatVersion === ApiPayloadFormatVersion.V1
            ? apig.PayloadFormatVersion.VERSION_1_0
            : apig.PayloadFormatVersion.VERSION_2_0;
        ///////////////////
        // Create Function
        ///////////////////
        let functionDefinition;
        if (typeof routeProps.function === "string") {
            functionDefinition = Object.assign(Object.assign({}, (this.defaultFunctionProps || {})), { handler: routeProps.function });
        }
        else if (routeProps.function instanceof Function_1.Function) {
            if (this.defaultFunctionProps) {
                throw new Error(`Cannot define defaultFunctionProps when a Function is passed in to the routes`);
            }
            functionDefinition = routeProps.function;
        }
        else {
            functionDefinition = Object.assign(Object.assign({}, (this.defaultFunctionProps || {})), routeProps.function);
        }
        const lambda = Function_1.Function.fromDefinition(scope, `Lambda_${methodStr}_${path}`, functionDefinition);
        ///////////////////
        // Create route
        ///////////////////
        const route = new apig.HttpRoute(scope, `Route_${methodStr}_${path}`, {
            httpApi: this.httpApi,
            routeKey: apig.HttpRouteKey.with(path, method),
            integration: new apigIntegrations.LambdaProxyIntegration({
                handler: lambda,
                payloadFormatVersion: integrationPayloadFormatVersion,
            }),
            authorizer,
            authorizationScopes,
        });
        // Configure route authorization type
        // Note: we need to explicitly set `cfnRoute.authorizationType` to `NONE` because if it were
        //       set to `AWS_IAM`, and then it is removed from the CloudFormation template
        //       (ie. set to undefined), CloudFormation doesn't updates the route. The route's
        //       authorizationType would still be `AWS_IAM`.
        if (authorizationType === ApiAuthorizationType.AWS_IAM ||
            authorizationType === ApiAuthorizationType.NONE) {
            if (!route.node.defaultChild) {
                throw new Error(`Failed to define the default route for "${routeKey}"`);
            }
            const cfnRoute = route.node.defaultChild;
            cfnRoute.authorizationType = authorizationType;
        }
        ///////////////////
        // Store function
        ///////////////////
        this.functions[routeKey] = lambda;
        return lambda;
    }
    isInstanceOfApiRouteProps(object) {
        return (object.function !== undefined || object.authorizationType !== undefined);
    }
    normalizeRouteKey(routeKey) {
        return routeKey.split(/\s+/).join(" ");
    }
    getFunction(routeKey) {
        return this.functions[this.normalizeRouteKey(routeKey)];
    }
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllRoutes.push(permissions);
    }
    attachPermissionsToRoute(routeKey, permissions) {
        const fn = this.getFunction(routeKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Route "${routeKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
}
exports.Api = Api;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0FwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbURBQXFDO0FBQ3JDLHdEQUEwQztBQUMxQyw4REFBZ0Q7QUFDaEQsNkVBQStEO0FBQy9ELHFFQUF1RDtBQUN2RCxnRUFBa0Q7QUFFbEQseUZBQTJFO0FBRzNFLHlDQUErRTtBQUcvRSxNQUFNLGNBQWMsR0FBRztJQUNyQixJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUc7SUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHO0lBQ25CLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRztJQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUk7SUFDcEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJO0lBQ3BCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSztJQUNyQixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU07SUFDdEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPO0NBQ3hCLENBQUM7QUFFRixJQUFZLG9CQUlYO0FBSkQsV0FBWSxvQkFBb0I7SUFDOUIsbUNBQVcsQ0FBQTtJQUNYLHFDQUFhLENBQUE7SUFDYiwyQ0FBbUIsQ0FBQTtBQUNyQixDQUFDLEVBSlcsb0JBQW9CLEdBQXBCLDRCQUFvQixLQUFwQiw0QkFBb0IsUUFJL0I7QUFFRCxJQUFZLHVCQUdYO0FBSEQsV0FBWSx1QkFBdUI7SUFDakMscUNBQVUsQ0FBQTtJQUNWLHFDQUFVLENBQUE7QUFDWixDQUFDLEVBSFcsdUJBQXVCLEdBQXZCLCtCQUF1QixLQUF2QiwrQkFBdUIsUUFHbEM7QUEwQ0QscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckIsTUFBYSxHQUFJLFNBQVEsR0FBRyxDQUFDLFNBQVM7SUFhcEMsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFnQjtRQUM1RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUs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ImltcG9ydCAqIGFzIGNkayBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMgbG9ncyBmcm9tIFwiQGF3cy1jZGsvYXdzLWxvZ3NcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTMgZnJvbSBcIkBhd3MtY2RrL2F3cy1yb3V0ZTUzXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzVGFyZ2V0cyBmcm9tIFwiQGF3cy1jZGsvYXdzLXJvdXRlNTMtdGFyZ2V0c1wiO1xuaW1wb3J0ICogYXMgYWNtIGZyb20gXCJAYXdzLWNkay9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyXCI7XG5pbXBvcnQgKiBhcyBhcGlnIGZyb20gXCJAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheXYyXCI7XG5pbXBvcnQgKiBhcyBhcGlnQXV0aG9yaXplcnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItYXV0aG9yaXplcnNcIjtcbmltcG9ydCAqIGFzIGFwaWdJbnRlZ3JhdGlvbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItaW50ZWdyYXRpb25zXCI7XG5cbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gYXMgRm4sIEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uRGVmaW5pdGlvbiB9IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuXG5jb25zdCBhbGxvd2VkTWV0aG9kcyA9IFtcbiAgYXBpZy5IdHRwTWV0aG9kLkFOWSxcbiAgYXBpZy5IdHRwTWV0aG9kLkdFVCxcbiAgYXBpZy5IdHRwTWV0aG9kLlBVVCxcbiAgYXBpZy5IdHRwTWV0aG9kLlBPU1QsXG4gIGFwaWcuSHR0cE1ldGhvZC5IRUFELFxuICBhcGlnLkh0dHBNZXRob2QuUEFUQ0gsXG4gIGFwaWcuSHR0cE1ldGhvZC5ERUxFVEUsXG4gIGFwaWcuSHR0cE1ldGhvZC5PUFRJT05TLFxuXTtcblxuZXhwb3J0IGVudW0gQXBpQXV0aG9yaXphdGlvblR5cGUge1xuICBKV1QgPSBcIkpXVFwiLFxuICBOT05FID0gXCJOT05FXCIsXG4gIEFXU19JQU0gPSBcIkFXU19JQU1cIixcbn1cblxuZXhwb3J0IGVudW0gQXBpUGF5bG9hZEZvcm1hdFZlcnNpb24ge1xuICBWMSA9IFwiMS4wXCIsXG4gIFYyID0gXCIyLjBcIixcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBBcGlQcm9wcyB7XG4gIHJlYWRvbmx5IGh0dHBBcGk/OiBhcGlnLklIdHRwQXBpIHwgYXBpZy5IdHRwQXBpUHJvcHM7XG4gIHJlYWRvbmx5IHJvdXRlcz86IHsgW2tleTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uIHwgQXBpUm91dGVQcm9wcyB9O1xuICByZWFkb25seSBjb3JzPzogYm9vbGVhbiB8IGFwaWcuQ29yc1ByZWZsaWdodE9wdGlvbnM7XG4gIHJlYWRvbmx5IGFjY2Vzc0xvZz86XG4gICAgfCBib29sZWFuXG4gICAgfCBzdHJpbmdcbiAgICB8IGFwaWcuQ2ZuU3RhZ2UuQWNjZXNzTG9nU2V0dGluZ3NQcm9wZXJ0eTtcbiAgcmVhZG9ubHkgY3VzdG9tRG9tYWluPzogc3RyaW5nIHwgQXBpQ3VzdG9tRG9tYWluUHJvcHM7XG5cbiAgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuICByZWFkb25seSBkZWZhdWx0QXV0aG9yaXphdGlvblR5cGU/OiBBcGlBdXRob3JpemF0aW9uVHlwZTtcbiAgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6ZXI/OlxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBKd3RBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cFVzZXJQb29sQXV0aG9yaXplcjtcbiAgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXM/OiBzdHJpbmdbXTtcbiAgcmVhZG9ubHkgZGVmYXVsdFBheWxvYWRGb3JtYXRWZXJzaW9uPzogQXBpUGF5bG9hZEZvcm1hdFZlcnNpb247XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBpUm91dGVQcm9wcyB7XG4gIHJlYWRvbmx5IGF1dGhvcml6YXRpb25UeXBlPzogQXBpQXV0aG9yaXphdGlvblR5cGU7XG4gIHJlYWRvbmx5IGF1dGhvcml6ZXI/OlxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBKd3RBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cFVzZXJQb29sQXV0aG9yaXplcjtcbiAgcmVhZG9ubHkgYXV0aG9yaXphdGlvblNjb3Blcz86IHN0cmluZ1tdO1xuICByZWFkb25seSBwYXlsb2FkRm9ybWF0VmVyc2lvbj86IEFwaVBheWxvYWRGb3JtYXRWZXJzaW9uO1xuICByZWFkb25seSBmdW5jdGlvbj86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcGlDdXN0b21Eb21haW5Qcm9wcyB7XG4gIHJlYWRvbmx5IGRvbWFpbk5hbWU6IHN0cmluZyB8IGFwaWcuSURvbWFpbk5hbWU7XG4gIHJlYWRvbmx5IGhvc3RlZFpvbmU/OiBzdHJpbmcgfCByb3V0ZTUzLklIb3N0ZWRab25lO1xuICByZWFkb25seSBjZXJ0aWZpY2F0ZT86IGFjbS5JQ2VydGlmaWNhdGU7XG4gIHJlYWRvbmx5IHBhdGg/OiBzdHJpbmc7XG59XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gQ29uc3RydWN0XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGNsYXNzIEFwaSBleHRlbmRzIGNkay5Db25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgaHR0cEFwaTogYXBpZy5IdHRwQXBpO1xuICBwdWJsaWMgcmVhZG9ubHkgYWNjZXNzTG9nR3JvdXA/OiBsb2dzLkxvZ0dyb3VwO1xuICBwcml2YXRlIHJlYWRvbmx5IGZ1bmN0aW9uczogeyBba2V5OiBzdHJpbmddOiBGbiB9O1xuICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXM6IFBlcm1pc3Npb25zW107XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemVyPzpcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwSnd0QXV0aG9yaXplclxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBVc2VyUG9vbEF1dGhvcml6ZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlPzogQXBpQXV0aG9yaXphdGlvblR5cGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXM/OiBzdHJpbmdbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0UGF5bG9hZEZvcm1hdFZlcnNpb24/OiBBcGlQYXlsb2FkRm9ybWF0VmVyc2lvbjtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBBcGlQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICBjb25zdCB7XG4gICAgICBodHRwQXBpLFxuICAgICAgcm91dGVzLFxuICAgICAgY29ycyxcbiAgICAgIGFjY2Vzc0xvZyxcbiAgICAgIGN1c3RvbURvbWFpbixcbiAgICAgIGRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgZGVmYXVsdEF1dGhvcml6ZXIsXG4gICAgICBkZWZhdWx0QXV0aG9yaXphdGlvblR5cGUsXG4gICAgICBkZWZhdWx0QXV0aG9yaXphdGlvblNjb3BlcyxcbiAgICAgIGRlZmF1bHRQYXlsb2FkRm9ybWF0VmVyc2lvbixcbiAgICB9ID0gcHJvcHMgfHwge307XG4gICAgdGhpcy5mdW5jdGlvbnMgPSB7fTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXMgPSBbXTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gZGVmYXVsdEZ1bmN0aW9uUHJvcHM7XG4gICAgdGhpcy5kZWZhdWx0QXV0aG9yaXplciA9IGRlZmF1bHRBdXRob3JpemVyO1xuICAgIHRoaXMuZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlID0gZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlO1xuICAgIHRoaXMuZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXMgPSBkZWZhdWx0QXV0aG9yaXphdGlvblNjb3BlcztcbiAgICB0aGlzLmRlZmF1bHRQYXlsb2FkRm9ybWF0VmVyc2lvbiA9IGRlZmF1bHRQYXlsb2FkRm9ybWF0VmVyc2lvbjtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIEFwaVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoY2RrLkNvbnN0cnVjdC5pc0NvbnN0cnVjdChodHRwQXBpKSkge1xuICAgICAgaWYgKGNvcnMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiY29yc1wiIHdoZW4gXCJodHRwQXBpXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoYWNjZXNzTG9nICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImFjY2Vzc0xvZ1wiIHdoZW4gXCJodHRwQXBpXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoY3VzdG9tRG9tYWluICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImN1c3RvbURvbWFpblwiIHdoZW4gXCJodHRwQXBpXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICB0aGlzLmh0dHBBcGkgPSBodHRwQXBpIGFzIGFwaWcuSHR0cEFwaTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgaHR0cEFwaVByb3BzID0gKGh0dHBBcGkgfHwge30pIGFzIGFwaWcuSHR0cEFwaVByb3BzO1xuXG4gICAgICAvLyBWYWxpZGF0ZSBpbnB1dFxuICAgICAgaWYgKGh0dHBBcGlQcm9wcy5jb3JzUHJlZmxpZ2h0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImh0dHBBcGkuY29yc1ByZWZsaWdodFwiIGluIHRoZSBBcGlgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoaHR0cEFwaVByb3BzLmRlZmF1bHREb21haW5NYXBwaW5nICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImh0dHBBcGkuZGVmYXVsdERvbWFpbk1hcHBpbmdcIiBpbiB0aGUgQXBpYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjb3JzUHJlZmxpZ2h0ID0gdGhpcy5idWlsZENvcnNDb25maWcoY29ycyk7XG4gICAgICBjb25zdCBkZWZhdWx0RG9tYWluTWFwcGluZyA9IHRoaXMuYnVpbGRDdXN0b21Eb21haW5Db25maWcoY3VzdG9tRG9tYWluKTtcblxuICAgICAgdGhpcy5odHRwQXBpID0gbmV3IGFwaWcuSHR0cEFwaSh0aGlzLCBcIkFwaVwiLCB7XG4gICAgICAgIGFwaU5hbWU6IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAgIGNvcnNQcmVmbGlnaHQsXG4gICAgICAgIGRlZmF1bHREb21haW5NYXBwaW5nLFxuICAgICAgICAuLi5odHRwQXBpUHJvcHMsXG4gICAgICB9KTtcblxuICAgICAgdGhpcy5hY2Nlc3NMb2dHcm91cCA9IHRoaXMuYnVpbGRBY2Nlc3NMb2dDb25maWcoYWNjZXNzTG9nKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDb25maWd1cmUgcm91dGVzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICB0aGlzLmFkZFJvdXRlcyh0aGlzLCByb3V0ZXMgfHwge30pO1xuICB9XG5cbiAgYnVpbGRDb3JzQ29uZmlnKFxuICAgIGNvcnM6IGJvb2xlYW4gfCBhcGlnLkNvcnNQcmVmbGlnaHRPcHRpb25zIHwgdW5kZWZpbmVkXG4gICk6IGFwaWcuQ29yc1ByZWZsaWdodE9wdGlvbnMgfCB1bmRlZmluZWQge1xuICAgIC8vIEhhbmRsZSBjb3JzOiBmYWxzZVxuICAgIGlmIChjb3JzID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSBjb3JzOiB0cnVlIHwgdW5kZWZpbmVkXG4gICAgZWxzZSBpZiAoY29ycyA9PT0gdW5kZWZpbmVkIHx8IGNvcnMgPT09IHRydWUpIHtcbiAgICAgIC8vIFdlIHdhbnQgQ09SUyB0byBhbGxvdyBhbGwgbWV0aG9kcywgaG93ZXZlclxuICAgICAgLy8gLSBpZiB3ZSBzZXQgYWxsb3dNZXRob2RzIHRvIFtcIipcIl0sIHR5cGUgY2hlY2sgd291bGQgZmFpbCBiL2MgYWxsb3dNZXRob2RzXG4gICAgICAvLyAgIGlzIGV4cHRlY3RlZCB0byB0YWtlIGFuIGFycmF5IG9mIEh0dHBNZXRob2QsIG5vdCBcIipcIlxuICAgICAgLy8gLSBpZiB3ZSBzZXQgYWxsb3dNZXRob2QgdG8gYWxsIGFsbG93ZWRNZXRob2RzLCBDbG91ZEZvcm1hdGlvbiB3aWxsIGZhaWxcbiAgICAgIC8vICAgYi9jIEFOWSBpcyBub3QgYWNjZXB0YWJsZS5cbiAgICAgIC8vIFNvLCB3ZSBmaWx0ZXIgb3V0IEFOWSBmcm9tIGFsbG93ZWRNZXRob2RzLiBTZWUgQ0RLIGlzc3VlIC1cbiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MvYXdzLWNkay9pc3N1ZXMvMTAyMzBcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGFsbG93SGVhZGVyczogW1wiKlwiXSxcbiAgICAgICAgYWxsb3dNZXRob2RzOiBhbGxvd2VkTWV0aG9kcy5maWx0ZXIoKG0pID0+IG0gIT09IGFwaWcuSHR0cE1ldGhvZC5BTlkpLFxuICAgICAgICBhbGxvd09yaWdpbnM6IFtcIipcIl0sXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSBjb3JzOiBhcGlnLkNvcnNQcmVmbGlnaHRPcHRpb25zXG4gICAgZWxzZSB7XG4gICAgICByZXR1cm4gY29ycztcbiAgICB9XG4gIH1cblxuICBidWlsZEN1c3RvbURvbWFpbkNvbmZpZyhcbiAgICBjdXN0b21Eb21haW46IHN0cmluZyB8IEFwaUN1c3RvbURvbWFpblByb3BzIHwgdW5kZWZpbmVkXG4gICk6IGFwaWcuRGVmYXVsdERvbWFpbk1hcHBpbmdPcHRpb25zIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoY3VzdG9tRG9tYWluID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBUbyBiZSBpbXBsZW1lbnRlZDogdG8gYWxsb3cgbW9yZSBmbGV4aWJsZSB1c2UgY2FzZXMsIFNTVCBzaG91bGQgc3VwcG9ydCB0d28gbW9yZSB1c2UgY2FzZXM6XG4gICAgLy8gIDEuIEFsbG93IHVzZXIgcGFzc2luZyBpbiBgaG9zdGVkWm9uZWAgb2JqZWN0LiBUaGUgdXNlIGNhc2UgaXMgd2hlbiB0aGVyZSBhcmUgbXVsdGlwbGVcbiAgICAvLyAgICAgSG9zdGVkWm9uZXMgd2l0aCB0aGUgc2FtZSBkb21haW4sIGJ1dCBvbmUgaXMgcHVibGljLCBhbmQgb25lIGlzIHByaXZhdGUuXG4gICAgLy8gIDIuIEFsbG93IHVzZXIgcGFzc2luZyBpbiBgY2VydGlmaWNhdGVgIG9iamVjdC4gVGhlIHVzZSBjYXNlIGlzIGZvciB1c2VyIHRvIGNyZWF0ZSB3aWxkY2FyZFxuICAgIC8vICAgICBjZXJ0aWZpY2F0ZSBvciB1c2luZyBhbiBpbXBvcnRlZCBjZXJ0aWZpY2F0ZS5cbiAgICAvLyAgMy4gQWxsb3cgdXNlciBwYXNzaW5nIGluIGBhcGlnRG9tYWluYCBvYmplY3QuIFRoZSB1c2UgY2FzZSBpcyBhIHVzZXIgY3JlYXRlcyBtdWx0aXBsZSBBUElcbiAgICAvLyAgICAgZW5kcG9pbnRzLCBhbmQgaXMgbWFwcGluZyB0aGVtIHVuZGVyIHRoZSBzYW1lIGN1c3RvbSBkb21haW4uIGBzc3QuQXBpYCBuZWVkcyB0byBleHBvc2UgdGhlXG4gICAgLy8gICAgIGBhcGlnRG9tYWluYCBjb25zdHJ1Y3QgY3JlYXRlZCBpbiB0aGUgZmlyc3QgQXBpLCBhbmQgbGV0cyB1c2VyIHBhc3MgaXQgaW4gd2hlbiBjcmVhdGluZ1xuICAgIC8vICAgICB0aGUgc2Vjb25kIEFwaS5cblxuICAgIGxldCBkb21haW5OYW1lLFxuICAgICAgaG9zdGVkWm9uZSxcbiAgICAgIGhvc3RlZFpvbmVEb21haW4sXG4gICAgICBjZXJ0aWZpY2F0ZSxcbiAgICAgIGFwaWdEb21haW4sXG4gICAgICBtYXBwaW5nS2V5O1xuXG4gICAgLy8gY3VzdG9tRG9tYWluIHBhc3NlZCBpbiBhcyBhIHN0cmluZ1xuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluO1xuICAgICAgaG9zdGVkWm9uZURvbWFpbiA9IGN1c3RvbURvbWFpbi5zcGxpdChcIi5cIikuc2xpY2UoMSkuam9pbihcIi5cIik7XG4gICAgfVxuICAgIC8vIGN1c3RvbURvbWFpbiBwYXNzZWQgaW4gYXMgYW4gb2JqZWN0XG4gICAgZWxzZSB7XG4gICAgICBpZiAoIWN1c3RvbURvbWFpbi5kb21haW5OYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgTWlzc2luZyBcImRvbWFpbk5hbWVcIiBpbiBzc3QuQXBpJ3MgY3VzdG9tRG9tYWluIHNldHRpbmdgXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIHBhcnNlIGN1c3RvbURvbWFpbi5kb21haW5OYW1lXG4gICAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbi5kb21haW5OYW1lID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIGRvbWFpbk5hbWUgPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFwaWdEb21haW4gPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZTtcblxuICAgICAgICBpZiAoY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJob3N0ZWRab25lXCIgd2hlbiB0aGUgXCJkb21haW5OYW1lXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiY2VydGlmaWNhdGVcIiB3aGVuIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIHBhcnNlIGN1c3RvbURvbWFpbi5ob3N0ZWRab25lXG4gICAgICBpZiAoIWFwaWdEb21haW4pIHtcbiAgICAgICAgaWYgKCFjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgICAgICAgIGhvc3RlZFpvbmVEb21haW4gPSAoZG9tYWluTmFtZSBhcyBzdHJpbmcpXG4gICAgICAgICAgICAuc3BsaXQoXCIuXCIpXG4gICAgICAgICAgICAuc2xpY2UoMSlcbiAgICAgICAgICAgIC5qb2luKFwiLlwiKTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICBob3N0ZWRab25lRG9tYWluID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaG9zdGVkWm9uZSA9IGN1c3RvbURvbWFpbi5ob3N0ZWRab25lO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNlcnRpZmljYXRlID0gY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlO1xuICAgICAgbWFwcGluZ0tleSA9IGN1c3RvbURvbWFpbi5wYXRoO1xuICAgIH1cblxuICAgIGlmICghYXBpZ0RvbWFpbiAmJiBkb21haW5OYW1lKSB7XG4gICAgICAvLyBMb29rIHVwIGhvc3RlZCB6b25lXG4gICAgICBpZiAoIWhvc3RlZFpvbmUgJiYgaG9zdGVkWm9uZURvbWFpbikge1xuICAgICAgICBob3N0ZWRab25lID0gcm91dGU1My5Ib3N0ZWRab25lLmZyb21Mb29rdXAodGhpcywgXCJIb3N0ZWRab25lXCIsIHtcbiAgICAgICAgICBkb21haW5OYW1lOiBob3N0ZWRab25lRG9tYWluLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFob3N0ZWRab25lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGZpbmQgaG9zdGVkIHpvbmUgXCIke2hvc3RlZFpvbmVEb21haW59XCIgaW4gUm91dGUgNTNgXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSBjZXJ0aWZpY2F0ZVxuICAgICAgaWYgKCFjZXJ0aWZpY2F0ZSkge1xuICAgICAgICBjZXJ0aWZpY2F0ZSA9IG5ldyBhY20uQ2VydGlmaWNhdGUodGhpcywgXCJDZXJ0aWZpY2F0ZVwiLCB7XG4gICAgICAgICAgZG9tYWluTmFtZSxcbiAgICAgICAgICB2YWxpZGF0aW9uOiBhY20uQ2VydGlmaWNhdGVWYWxpZGF0aW9uLmZyb21EbnMoaG9zdGVkWm9uZSksXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDcmVhdGUgY3VzdG9tIGRvbWFpbiBpbiBBUEkgR2F0ZXdheVxuICAgICAgYXBpZ0RvbWFpbiA9IG5ldyBhcGlnLkRvbWFpbk5hbWUodGhpcywgXCJEb21haW5OYW1lXCIsIHtcbiAgICAgICAgZG9tYWluTmFtZSxcbiAgICAgICAgY2VydGlmaWNhdGUsXG4gICAgICB9KTtcblxuICAgICAgLy8gQ3JlYXRlIEROUyByZWNvcmRcbiAgICAgIG5ldyByb3V0ZTUzLkFSZWNvcmQodGhpcywgXCJBbGlhc1JlY29yZFwiLCB7XG4gICAgICAgIHJlY29yZE5hbWU6IGRvbWFpbk5hbWUsXG4gICAgICAgIHpvbmU6IGhvc3RlZFpvbmUsXG4gICAgICAgIHRhcmdldDogcm91dGU1My5SZWNvcmRUYXJnZXQuZnJvbUFsaWFzKFxuICAgICAgICAgIG5ldyByb3V0ZTUzVGFyZ2V0cy5BcGlHYXRld2F5djJEb21haW4oYXBpZ0RvbWFpbilcbiAgICAgICAgKSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBkb21haW5OYW1lOiBhcGlnRG9tYWluIGFzIGFwaWcuRG9tYWluTmFtZSxcbiAgICAgIG1hcHBpbmdLZXksXG4gICAgfTtcbiAgfVxuXG4gIGJ1aWxkQWNjZXNzTG9nQ29uZmlnKFxuICAgIGFjY2Vzc0xvZzpcbiAgICAgIHwgYm9vbGVhblxuICAgICAgfCBzdHJpbmdcbiAgICAgIHwgYXBpZy5DZm5TdGFnZS5BY2Nlc3NMb2dTZXR0aW5nc1Byb3BlcnR5XG4gICAgICB8IHVuZGVmaW5lZFxuICApOiBsb2dzLkxvZ0dyb3VwIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoYWNjZXNzTG9nID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIG5vdGU6IEFjY2VzcyBsb2cgY29uZmlndXJhdGlvbiBpcyBub3Qgc3VwcG9ydGVkIGJ5IEwyIGNvbnN0cnVjdHMgYXMgb2YgQ0RLIHYxLjg1LjAuIFdlXG4gICAgLy8gICAgICAgbmVlZCB0byBkZWZpbmUgaXQgYXQgTDEgY29uc3RydWN0IGxldmVsLlxuXG4gICAgLy8gY3JlYXRlIGxvZyBncm91cFxuICAgIGxldCBsb2dHcm91cDtcbiAgICBsZXQgZGVzdGluYXRpb25Bcm47XG4gICAgaWYgKFxuICAgICAgYWNjZXNzTG9nICYmXG4gICAgICAoYWNjZXNzTG9nIGFzIGFwaWcuQ2ZuU3RhZ2UuQWNjZXNzTG9nU2V0dGluZ3NQcm9wZXJ0eSkuZGVzdGluYXRpb25Bcm5cbiAgICApIHtcbiAgICAgIGRlc3RpbmF0aW9uQXJuID0gKGFjY2Vzc0xvZyBhcyBhcGlnLkNmblN0YWdlLkFjY2Vzc0xvZ1NldHRpbmdzUHJvcGVydHkpXG4gICAgICAgIC5kZXN0aW5hdGlvbkFybjtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nR3JvdXAgPSBuZXcgbG9ncy5Mb2dHcm91cCh0aGlzLCBcIkxvZ0dyb3VwXCIpO1xuICAgICAgZGVzdGluYXRpb25Bcm4gPSBsb2dHcm91cC5sb2dHcm91cEFybjtcbiAgICB9XG5cbiAgICAvLyBnZXQgbG9nIGZvcm1hdFxuICAgIGxldCBmb3JtYXQ7XG4gICAgaWYgKFxuICAgICAgYWNjZXNzTG9nICYmXG4gICAgICAoYWNjZXNzTG9nIGFzIGFwaWcuQ2ZuU3RhZ2UuQWNjZXNzTG9nU2V0dGluZ3NQcm9wZXJ0eSkuZm9ybWF0XG4gICAgKSB7XG4gICAgICBmb3JtYXQgPSAoYWNjZXNzTG9nIGFzIGFwaWcuQ2ZuU3RhZ2UuQWNjZXNzTG9nU2V0dGluZ3NQcm9wZXJ0eSkuZm9ybWF0O1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGFjY2Vzc0xvZyA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgZm9ybWF0ID0gYWNjZXNzTG9nO1xuICAgIH0gZWxzZSB7XG4gICAgICBmb3JtYXQgPSBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIC8vIHJlcXVlc3QgaW5mb1xuICAgICAgICByZXF1ZXN0VGltZTogXCIkY29udGV4dC5yZXF1ZXN0VGltZVwiLFxuICAgICAgICByZXF1ZXN0SWQ6IFwiJGNvbnRleHQucmVxdWVzdElkXCIsXG4gICAgICAgIGh0dHBNZXRob2Q6IFwiJGNvbnRleHQuaHR0cE1ldGhvZFwiLFxuICAgICAgICBwYXRoOiBcIiRjb250ZXh0LnBhdGhcIixcbiAgICAgICAgcm91dGVLZXk6IFwiJGNvbnRleHQucm91dGVLZXlcIixcbiAgICAgICAgc3RhdHVzOiBcIiRjb250ZXh0LnN0YXR1c1wiLFxuICAgICAgICByZXNwb25zZUxhdGVuY3k6IFwiJGNvbnRleHQucmVzcG9uc2VMYXRlbmN5XCIsXG4gICAgICAgIC8vIGludGVncmF0aW9uIGluZm9cbiAgICAgICAgaW50ZWdyYXRpb25SZXF1ZXN0SWQ6IFwiJGNvbnRleHQuaW50ZWdyYXRpb24ucmVxdWVzdElkXCIsXG4gICAgICAgIGludGVncmF0aW9uU3RhdHVzOiBcIiRjb250ZXh0LmludGVncmF0aW9uLnN0YXR1c1wiLFxuICAgICAgICBpbnRlZ3JhdGlvbkxhdGVuY3k6IFwiJGNvbnRleHQuaW50ZWdyYXRpb24ubGF0ZW5jeVwiLFxuICAgICAgICBpbnRlZ3JhdGlvblNlcnZpY2VTdGF0dXM6IFwiJGNvbnRleHQuaW50ZWdyYXRpb24uaW50ZWdyYXRpb25TdGF0dXNcIixcbiAgICAgICAgLy8gY2FsbGVyIGluZm9cbiAgICAgICAgaXA6IFwiJGNvbnRleHQuaWRlbnRpdHkuc291cmNlSXBcIixcbiAgICAgICAgdXNlckFnZW50OiBcIiRjb250ZXh0LmlkZW50aXR5LnVzZXJBZ2VudFwiLFxuICAgICAgICBjb2duaXRvSWRlbnRpdHlJZDogXCIkY29udGV4dC5pZGVudGl0eS5jb2duaXRvSWRlbnRpdHlJZFwiLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gZ2V0IEwxIGNmblN0YWdlIGNvbnN0cnVjdFxuICAgIGlmICghdGhpcy5odHRwQXBpLmRlZmF1bHRTdGFnZT8ubm9kZS5kZWZhdWx0Q2hpbGQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGRlZmluZSB0aGUgZGVmYXVsdCBzdGFnZSBmb3IgSHR0cCBBUElgKTtcbiAgICB9XG5cbiAgICAvLyBzZXQgYWNjZXNzIGxvZyBzZXR0aW5nc1xuICAgIGNvbnN0IGNmblN0YWdlID0gdGhpcy5odHRwQXBpLmRlZmF1bHRTdGFnZS5ub2RlXG4gICAgICAuZGVmYXVsdENoaWxkIGFzIGFwaWcuQ2ZuU3RhZ2U7XG4gICAgY2ZuU3RhZ2UuYWNjZXNzTG9nU2V0dGluZ3MgPSB7IGZvcm1hdCwgZGVzdGluYXRpb25Bcm4gfTtcblxuICAgIHJldHVybiBsb2dHcm91cDtcbiAgfVxuXG4gIGFkZFJvdXRlcyhcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICByb3V0ZXM6IHtcbiAgICAgIFtrZXk6IHN0cmluZ106IEZ1bmN0aW9uRGVmaW5pdGlvbiB8IEFwaVJvdXRlUHJvcHM7XG4gICAgfVxuICApOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyhyb3V0ZXMpLmZvckVhY2goKHJvdXRlS2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIC8vIGFkZCByb3V0ZVxuICAgICAgY29uc3QgZm4gPSB0aGlzLmFkZFJvdXRlKHNjb3BlLCByb3V0ZUtleSwgcm91dGVzW3JvdXRlS2V5XSk7XG5cbiAgICAgIC8vIGF0dGFjaGVkIGV4aXN0aW5nIHBlcm1pc3Npb25zXG4gICAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXMuZm9yRWFjaCgocGVybWlzc2lvbnMpID0+XG4gICAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFkZFJvdXRlKFxuICAgIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcm91dGVWYWx1ZTogRnVuY3Rpb25EZWZpbml0aW9uIHwgQXBpUm91dGVQcm9wc1xuICApOiBGbiB7XG4gICAgLy8gTm9ybWFsaXplIHJvdXRlUHJvcHNcbiAgICBjb25zdCByb3V0ZVByb3BzID0gKHRoaXMuaXNJbnN0YW5jZU9mQXBpUm91dGVQcm9wcyhcbiAgICAgIHJvdXRlVmFsdWUgYXMgQXBpUm91dGVQcm9wc1xuICAgIClcbiAgICAgID8gcm91dGVWYWx1ZVxuICAgICAgOiB7IGZ1bmN0aW9uOiByb3V0ZVZhbHVlIGFzIEZ1bmN0aW9uRGVmaW5pdGlvbiB9KSBhcyBBcGlSb3V0ZVByb3BzO1xuXG4gICAgLy8gTm9ybWFsaXplIHJvdXRlS2V5XG4gICAgcm91dGVLZXkgPSB0aGlzLm5vcm1hbGl6ZVJvdXRlS2V5KHJvdXRlS2V5KTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBHZXQgcGF0aCBhbmQgbWV0aG9kXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IHJvdXRlS2V5UGFydHMgPSByb3V0ZUtleS5zcGxpdChcIiBcIik7XG4gICAgaWYgKHJvdXRlS2V5UGFydHMubGVuZ3RoICE9PSAyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcm91dGUgJHtyb3V0ZUtleX1gKTtcbiAgICB9XG4gICAgY29uc3QgbWV0aG9kU3RyID0gcm91dGVLZXlQYXJ0c1swXS50b1VwcGVyQ2FzZSgpO1xuICAgIGNvbnN0IHBhdGggPSByb3V0ZUtleVBhcnRzWzFdO1xuICAgIGNvbnN0IG1ldGhvZCA9IGFsbG93ZWRNZXRob2RzLmZpbmQoKHBlcikgPT4gcGVyID09PSBtZXRob2RTdHIpO1xuICAgIGlmICghbWV0aG9kKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgbWV0aG9kIGRlZmluZWQgZm9yIFwiJHtyb3V0ZUtleX1cImApO1xuICAgIH1cbiAgICBpZiAocGF0aC5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwYXRoIGRlZmluZWQgZm9yIFwiJHtyb3V0ZUtleX1cImApO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBHZXQgYXV0aG9yaXphdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBhdXRob3JpemF0aW9uVHlwZSA9XG4gICAgICByb3V0ZVByb3BzLmF1dGhvcml6YXRpb25UeXBlIHx8XG4gICAgICB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uVHlwZSB8fFxuICAgICAgQXBpQXV0aG9yaXphdGlvblR5cGUuTk9ORTtcbiAgICBpZiAoIU9iamVjdC52YWx1ZXMoQXBpQXV0aG9yaXphdGlvblR5cGUpLmluY2x1ZGVzKGF1dGhvcml6YXRpb25UeXBlKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgc3N0LkFwaSBkb2VzIG5vdCBjdXJyZW50bHkgc3VwcG9ydCAke2F1dGhvcml6YXRpb25UeXBlfS4gT25seSBcIkFXU19JQU1cIiBhbmQgXCJKV1RcIiBhcmUgY3VycmVudGx5IHN1cHBvcnRlZC5gXG4gICAgICApO1xuICAgIH1cbiAgICBsZXQgYXV0aG9yaXplciwgYXV0aG9yaXphdGlvblNjb3BlcztcbiAgICBpZiAoYXV0aG9yaXphdGlvblR5cGUgPT09IEFwaUF1dGhvcml6YXRpb25UeXBlLkpXVCkge1xuICAgICAgYXV0aG9yaXplciA9IHJvdXRlUHJvcHMuYXV0aG9yaXplciB8fCB0aGlzLmRlZmF1bHRBdXRob3JpemVyO1xuICAgICAgYXV0aG9yaXphdGlvblNjb3BlcyA9XG4gICAgICAgIHJvdXRlUHJvcHMuYXV0aG9yaXphdGlvblNjb3BlcyB8fCB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzO1xuICAgIH1cbiAgICBpZiAoYXV0aG9yaXphdGlvblR5cGUgPT09IEFwaUF1dGhvcml6YXRpb25UeXBlLkpXVCAmJiAhYXV0aG9yaXplcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIEpXVCBhdXRob3JpemVyIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gR2V0IHBheWxvYWQgZm9ybWF0XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IHBheWxvYWRGb3JtYXRWZXJzaW9uID1cbiAgICAgIHJvdXRlUHJvcHMucGF5bG9hZEZvcm1hdFZlcnNpb24gfHxcbiAgICAgIHRoaXMuZGVmYXVsdFBheWxvYWRGb3JtYXRWZXJzaW9uIHx8XG4gICAgICBBcGlQYXlsb2FkRm9ybWF0VmVyc2lvbi5WMjtcbiAgICBpZiAoXG4gICAgICAhT2JqZWN0LnZhbHVlcyhBcGlQYXlsb2FkRm9ybWF0VmVyc2lvbikuaW5jbHVkZXMocGF5bG9hZEZvcm1hdFZlcnNpb24pXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBzc3QuQXBpIGRvZXMgbm90IGN1cnJlbnRseSBzdXBwb3J0ICR7cGF5bG9hZEZvcm1hdFZlcnNpb259IHBheWxvYWQgZm9ybWF0IHZlcnNpb24uIE9ubHkgXCJWMVwiIGFuZCBcIlYyXCIgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQuYFxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgaW50ZWdyYXRpb25QYXlsb2FkRm9ybWF0VmVyc2lvbiA9XG4gICAgICBwYXlsb2FkRm9ybWF0VmVyc2lvbiA9PT0gQXBpUGF5bG9hZEZvcm1hdFZlcnNpb24uVjFcbiAgICAgICAgPyBhcGlnLlBheWxvYWRGb3JtYXRWZXJzaW9uLlZFUlNJT05fMV8wXG4gICAgICAgIDogYXBpZy5QYXlsb2FkRm9ybWF0VmVyc2lvbi5WRVJTSU9OXzJfMDtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgRnVuY3Rpb25cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgbGV0IGZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgICBpZiAodHlwZW9mIHJvdXRlUHJvcHMuZnVuY3Rpb24gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGZ1bmN0aW9uRGVmaW5pdGlvbiA9IHtcbiAgICAgICAgLi4uKHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMgfHwge30pLFxuICAgICAgICBoYW5kbGVyOiByb3V0ZVByb3BzLmZ1bmN0aW9uLFxuICAgICAgfTtcbiAgICB9IGVsc2UgaWYgKHJvdXRlUHJvcHMuZnVuY3Rpb24gaW5zdGFuY2VvZiBGbikge1xuICAgICAgaWYgKHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgZGVmaW5lIGRlZmF1bHRGdW5jdGlvblByb3BzIHdoZW4gYSBGdW5jdGlvbiBpcyBwYXNzZWQgaW4gdG8gdGhlIHJvdXRlc2BcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGZ1bmN0aW9uRGVmaW5pdGlvbiA9IHJvdXRlUHJvcHMuZnVuY3Rpb247XG4gICAgfSBlbHNlIHtcbiAgICAgIGZ1bmN0aW9uRGVmaW5pdGlvbiA9IHtcbiAgICAgICAgLi4uKHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMgfHwge30pLFxuICAgICAgICAuLi4ocm91dGVQcm9wcy5mdW5jdGlvbiBhcyBGdW5jdGlvblByb3BzKSxcbiAgICAgIH0gYXMgRnVuY3Rpb25Qcm9wcztcbiAgICB9XG4gICAgY29uc3QgbGFtYmRhID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICBzY29wZSxcbiAgICAgIGBMYW1iZGFfJHttZXRob2RTdHJ9XyR7cGF0aH1gLFxuICAgICAgZnVuY3Rpb25EZWZpbml0aW9uXG4gICAgKTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgcm91dGVcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3Qgcm91dGUgPSBuZXcgYXBpZy5IdHRwUm91dGUoc2NvcGUsIGBSb3V0ZV8ke21ldGhvZFN0cn1fJHtwYXRofWAsIHtcbiAgICAgIGh0dHBBcGk6IHRoaXMuaHR0cEFwaSxcbiAgICAgIHJvdXRlS2V5OiBhcGlnLkh0dHBSb3V0ZUtleS53aXRoKHBhdGgsIG1ldGhvZCksXG4gICAgICBpbnRlZ3JhdGlvbjogbmV3IGFwaWdJbnRlZ3JhdGlvbnMuTGFtYmRhUHJveHlJbnRlZ3JhdGlvbih7XG4gICAgICAgIGhhbmRsZXI6IGxhbWJkYSxcbiAgICAgICAgcGF5bG9hZEZvcm1hdFZlcnNpb246IGludGVncmF0aW9uUGF5bG9hZEZvcm1hdFZlcnNpb24sXG4gICAgICB9KSxcbiAgICAgIGF1dGhvcml6ZXIsXG4gICAgICBhdXRob3JpemF0aW9uU2NvcGVzLFxuICAgIH0pO1xuXG4gICAgLy8gQ29uZmlndXJlIHJvdXRlIGF1dGhvcml6YXRpb24gdHlwZVxuICAgIC8vIE5vdGU6IHdlIG5lZWQgdG8gZXhwbGljaXRseSBzZXQgYGNmblJvdXRlLmF1dGhvcml6YXRpb25UeXBlYCB0byBgTk9ORWAgYmVjYXVzZSBpZiBpdCB3ZXJlXG4gICAgLy8gICAgICAgc2V0IHRvIGBBV1NfSUFNYCwgYW5kIHRoZW4gaXQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBDbG91ZEZvcm1hdGlvbiB0ZW1wbGF0ZVxuICAgIC8vICAgICAgIChpZS4gc2V0IHRvIHVuZGVmaW5lZCksIENsb3VkRm9ybWF0aW9uIGRvZXNuJ3QgdXBkYXRlcyB0aGUgcm91dGUuIFRoZSByb3V0ZSdzXG4gICAgLy8gICAgICAgYXV0aG9yaXphdGlvblR5cGUgd291bGQgc3RpbGwgYmUgYEFXU19JQU1gLlxuICAgIGlmIChcbiAgICAgIGF1dGhvcml6YXRpb25UeXBlID09PSBBcGlBdXRob3JpemF0aW9uVHlwZS5BV1NfSUFNIHx8XG4gICAgICBhdXRob3JpemF0aW9uVHlwZSA9PT0gQXBpQXV0aG9yaXphdGlvblR5cGUuTk9ORVxuICAgICkge1xuICAgICAgaWYgKCFyb3V0ZS5ub2RlLmRlZmF1bHRDaGlsZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBkZWZpbmUgdGhlIGRlZmF1bHQgcm91dGUgZm9yIFwiJHtyb3V0ZUtleX1cImApO1xuICAgICAgfVxuICAgICAgY29uc3QgY2ZuUm91dGUgPSByb3V0ZS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBhcGlnLkNmblJvdXRlO1xuICAgICAgY2ZuUm91dGUuYXV0aG9yaXphdGlvblR5cGUgPSBhdXRob3JpemF0aW9uVHlwZTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gU3RvcmUgZnVuY3Rpb25cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgdGhpcy5mdW5jdGlvbnNbcm91dGVLZXldID0gbGFtYmRhO1xuXG4gICAgcmV0dXJuIGxhbWJkYTtcbiAgfVxuXG4gIGlzSW5zdGFuY2VPZkFwaVJvdXRlUHJvcHMob2JqZWN0OiBBcGlSb3V0ZVByb3BzKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChcbiAgICAgIG9iamVjdC5mdW5jdGlvbiAhPT0gdW5kZWZpbmVkIHx8IG9iamVjdC5hdXRob3JpemF0aW9uVHlwZSAhPT0gdW5kZWZpbmVkXG4gICAgKTtcbiAgfVxuXG4gIG5vcm1hbGl6ZVJvdXRlS2V5KHJvdXRlS2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiByb3V0ZUtleS5zcGxpdCgvXFxzKy8pLmpvaW4oXCIgXCIpO1xuICB9XG5cbiAgZ2V0RnVuY3Rpb24ocm91dGVLZXk6IHN0cmluZyk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5mdW5jdGlvbnNbdGhpcy5ub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleSldO1xuICB9XG5cbiAgYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgT2JqZWN0LnZhbHVlcyh0aGlzLmZ1bmN0aW9ucykuZm9yRWFjaCgoZm4pID0+XG4gICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICApO1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlcy5wdXNoKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIGF0dGFjaFBlcm1pc3Npb25zVG9Sb3V0ZShyb3V0ZUtleTogc3RyaW5nLCBwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBjb25zdCBmbiA9IHRoaXMuZ2V0RnVuY3Rpb24ocm91dGVLZXkpO1xuICAgIGlmICghZm4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBhdHRhY2ggcGVybWlzc2lvbnMuIFJvdXRlIFwiJHtyb3V0ZUtleX1cIiBkb2VzIG5vdCBleGlzdC5gXG4gICAgICApO1xuICAgIH1cblxuICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxufVxuIl19